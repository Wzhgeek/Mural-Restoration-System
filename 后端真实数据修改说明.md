# 后端真实数据修改说明

## 问题发现
您完全正确！经过仔细检查，发现后端API `/api/dashboard` 确实在使用**模拟数据**而不是从数据库获取真实数据。

## 问题位置
**文件**: `main.py`  
**函数**: `get_dashboard_stats()`  
**行数**: 299-314行（管理员）和 343-349行（评估专家）

## 原始问题代码

### 工作流趋势数据（模拟）
```python
# 第299行 - 模拟趋势
dashboard_data["workflow_trend"] = round(random.uniform(-5, 15), 1)  # 模拟趋势

# 第302-305行 - 模拟工作流趋势数据
dashboard_data["workflow_trend_data"] = {
    "labels": ["周一", "周二", "周三", "周四", "周五", "周六", "周日"],
    "values": [random.randint(1, 8) for _ in range(7)]  # 随机数据！
}
```

### 评分分布数据（模拟）
```python
# 第308-314行 - 模拟评分分布数据
dashboard_data["score_distribution"] = {
    "0-6": random.randint(0, 3),
    "6-7": random.randint(2, 8),
    "7-8": random.randint(5, 15),
    "8-9": random.randint(8, 20),
    "9-10": random.randint(3, 12)
}
```

## 修改后的真实数据实现

### 1. 工作流趋势数据（真实数据）
```python
# 计算最近7天的工作流创建趋势
from datetime import datetime, timedelta
today = datetime.now().date()
week_ago = today - timedelta(days=6)

# 获取最近7天每天的工作流创建数量
daily_workflows = []
labels = []

for i in range(7):
    current_date = week_ago + timedelta(days=i)
    count = db.query(Workflow).filter(
        func.date(Workflow.created_at) == current_date
    ).count()
    daily_workflows.append(count)
    
    # 生成中文日期标签
    weekdays = ['周一', '周二', '周三', '周四', '周五', '周六', '周日']
    labels.append(weekdays[current_date.weekday()])

# 计算趋势（与上周对比）
this_week_total = sum(daily_workflows)
last_week_start = week_ago - timedelta(days=7)
last_week_total = db.query(Workflow).filter(
    func.date(Workflow.created_at) >= last_week_start,
    func.date(Workflow.created_at) < week_ago
).count()

if last_week_total > 0:
    workflow_trend = round(((this_week_total - last_week_total) / last_week_total) * 100, 1)
else:
    workflow_trend = 0.0 if this_week_total == 0 else 100.0

dashboard_data["workflow_trend"] = workflow_trend
dashboard_data["workflow_trend_data"] = {
    "labels": labels,
    "values": daily_workflows
}
```

### 2. 评分分布数据（真实数据）

#### 管理员版本（所有评估记录）
```python
# 统计所有评估记录的评分分布
score_ranges = {
    "0-6": 0,   # 0-60分
    "6-7": 0,   # 60-70分
    "7-8": 0,   # 70-80分
    "8-9": 0,   # 80-90分
    "9-10": 0   # 90-100分
}

# 获取所有评估记录的评分
evaluations = db.query(Evaluation).all()
for evaluation in evaluations:
    score = evaluation.score
    if score < 60:
        score_ranges["0-6"] += 1
    elif score < 70:
        score_ranges["6-7"] += 1
    elif score < 80:
        score_ranges["7-8"] += 1
    elif score < 90:
        score_ranges["8-9"] += 1
    else:
        score_ranges["9-10"] += 1

dashboard_data["score_distribution"] = score_ranges
```

#### 评估专家版本（自己的评估记录）
```python
# 获取当前评估专家的评估记录
my_evaluations = db.query(Evaluation).filter(
    Evaluation.evaluator_id == current_user.user_id
).all()

# 统计评分分布（同上逻辑）
```

## 数据来源说明

### 工作流趋势数据
- **数据表**: `workflow` 表
- **字段**: `created_at` 创建时间
- **统计方式**: 按日期统计最近7天每天创建的工作流数量
- **趋势计算**: 与上周同期对比计算增长率

### 评分分布数据
- **数据表**: `evaluation` 表
- **字段**: `score` 评分字段
- **统计方式**: 按评分区间统计评估记录数量
- **评分区间**: 
  - 0-6: 0-60分（较差）
  - 6-7: 60-70分（一般）
  - 7-8: 70-80分（良好）
  - 8-9: 80-90分（优秀）
  - 9-10: 90-100分（卓越）

## 角色权限区分

### 管理员
- 工作流趋势：所有工作流的创建趋势
- 评分分布：所有评估记录的评分分布

### 评估专家
- 工作流趋势：不显示（评估专家不关心工作流创建趋势）
- 评分分布：只显示自己评估记录的评分分布

### 修复专家
- 工作流趋势：不显示
- 评分分布：不显示（修复专家不进行评估）

## 验证方法

1. **启动后端服务**：确保服务运行在8080端口
2. **登录系统**：使用不同角色账号登录
3. **访问仪表盘**：查看图表数据是否显示真实数据
4. **数据库验证**：直接在数据库中查询相关表，对比数据是否一致

## 作者信息
- **作者**: 王梓涵
- **邮箱**: wangzh011031@163.com
- **修改时间**: 2025年
- **系统名称**: 克孜尔石窟壁画智慧修复全生命周期管理系统
