# 克孜尔石窟壁画智慧修复全生命周期管理系统 - 后端技术开发文档

## 1. 项目概述

### 1.1 系统简介
克孜尔石窟壁画智慧修复全生命周期管理系统是一个专门为文物修复工作设计的管理平台，用于管理壁画修复的完整工作流程，包括修复方案提交、评估、回溯等功能。

### 1.2 技术架构
- **后端框架**: FastAPI (Python 3.8+)
- **数据库**: PostgreSQL
- **ORM**: SQLAlchemy
- **认证**: JWT (JSON Web Token)
- **文件存储**: MinIO
- **缓存**: Redis
- **密码加密**: Bcrypt
- **API文档**: 自动生成的 OpenAPI/Swagger

### 1.3 系统角色
- **管理员 (admin)**: 系统管理、用户管理、审批回溯申请
- **修复专家 (restorer)**: 创建工作流、提交修复表单、申请回溯
- **评估专家 (evaluator)**: 对完成的工作流进行评估打分

## 2. 项目结构

```
project/
├── app/                        # 应用主目录
│   ├── __init__.py
│   ├── api/                   # API路由模块
│   │   ├── __init__.py
│   │   └── routes.py          # 扩展API路由
│   ├── auth/                  # 认证模块
│   │   ├── __init__.py
│   │   └── auth.py            # JWT认证和权限控制
│   ├── core/                  # 核心配置
│   │   ├── __init__.py
│   │   ├── config.py          # 系统配置
│   │   └── database.py        # 数据库连接和初始化
│   ├── models/                # 数据模型
│   │   ├── __init__.py
│   │   └── models.py          # SQLAlchemy模型定义
│   ├── schemas/               # Pydantic模型
│   │   ├── __init__.py
│   │   └── schemas.py         # 请求/响应数据模型
│   └── services/              # 业务服务
│       ├── __init__.py
│       └── file_service.py    # 文件上传服务
├── static/                    # 静态文件目录
│   ├── index.html            # 主页面
│   ├── login.html            # 登录页面
│   ├── css/                  # 样式文件
│   └── js/                   # JavaScript文件
├── main.py                    # 应用入口
├── requirements.txt           # Python依赖
├── docker-compose.yml         # Docker配置
└── .env                       # 环境变量配置
```

## 3. 数据库设计

### 3.1 数据表结构

#### roles - 角色表
| 字段 | 类型 | 说明 |
|------|------|------|
| role_id | Integer | 主键，自增 |
| role_key | String(20) | 角色标识，唯一 |
| role_name | String(50) | 角色名称 |

#### users - 用户表
| 字段 | 类型 | 说明 |
|------|------|------|
| user_id | Integer | 主键，自增 |
| username | String(50) | 用户名，唯一 |
| password_hash | String(255) | 密码哈希 |
| full_name | String(100) | 姓名 |
| role_id | Integer | 角色ID，外键 |
| email | String(100) | 邮箱，唯一 |
| phone | String(20) | 电话 |
| is_active | Boolean | 是否激活 |
| created_at | Timestamp | 创建时间 |
| updated_at | Timestamp | 更新时间 |
| deleted_at | Timestamp | 软删除时间 |

#### workflows - 工作流表
| 字段 | 类型 | 说明 |
|------|------|------|
| workflow_id | UUID | 主键 |
| title | String(255) | 标题 |
| description | Text | 描述 |
| initiator_id | Integer | 发起人ID，外键 |
| current_step | Integer | 当前步骤 |
| status | String(20) | 状态(draft/running/paused/finished/revoked) |
| is_finalized | Boolean | 是否最终化 |
| created_at | Timestamp | 创建时间 |
| updated_at | Timestamp | 更新时间 |

#### forms - 修复表单表
| 字段 | 类型 | 说明 |
|------|------|------|
| form_id | UUID | 主键 |
| workflow_id | UUID | 工作流ID，外键 |
| step_no | Integer | 步骤号 |
| submitter_id | Integer | 提交人ID，外键 |
| image_url | Text | 图片URL |
| image_meta | JSONB | 图片元数据 |
| image_desc | Text | 图片描述 |
| image_desc_file | Text | 图片描述文件URL |
| restoration_opinion | Text | 修复意见 |
| opinion_tags | Array[String] | 意见标签 |
| opinion_file | Text | 意见文件URL |
| remark | Text | 备注 |
| attachment | Text | 附件URL |
| is_rollback_from | UUID | 回溯来源表单ID |
| created_at | Timestamp | 创建时间 |
| updated_at | Timestamp | 更新时间 |
| deleted_at | Timestamp | 软删除时间 |

#### evaluations - 评估表
| 字段 | 类型 | 说明 |
|------|------|------|
| evaluate_id | Integer | 主键，自增 |
| workflow_id | UUID | 工作流ID，外键 |
| evaluator_id | Integer | 评估人ID，外键 |
| score | SmallInteger | 评分(0-100) |
| comment | Text | 评价 |
| evaluation_file | Text | 评估文件URL |
| created_at | Timestamp | 创建时间 |
| updated_at | Timestamp | 更新时间 |

#### rollback_requests - 回溯申请表
| 字段 | 类型 | 说明 |
|------|------|------|
| rollback_id | Integer | 主键，自增 |
| workflow_id | UUID | 工作流ID，外键 |
| requester_id | Integer | 申请人ID，外键 |
| target_form_id | UUID | 目标表单ID，外键 |
| reason | Text | 申请原因 |
| support_file_url | Text | 支撑文件URL |
| status | String(20) | 状态(pending/approved/rejected) |
| approver_id | Integer | 审批人ID，外键 |
| approved_at | Timestamp | 审批时间 |
| created_at | Timestamp | 创建时间 |
| deleted_at | Timestamp | 软删除时间 |

#### step_logs - 操作日志表
| 字段 | 类型 | 说明 |
|------|------|------|
| step_log_id | Integer | 主键，自增 |
| form_id | UUID | 表单ID，外键 |
| action | String(20) | 操作类型 |
| operator_id | Integer | 操作人ID，外键 |
| comment | Text | 备注 |
| created_at | Timestamp | 创建时间 |

#### system_configs - 系统配置表
| 字段 | 类型 | 说明 |
|------|------|------|
| config_key | String(50) | 配置键，主键 |
| config_value | Text | 配置值 |
| description | String(255) | 描述 |
| updated_at | Timestamp | 更新时间 |

### 3.2 数据关系
- User -> Role: 多对一
- Workflow -> User: 多对一（发起人）
- Form -> Workflow: 多对一
- Form -> User: 多对一（提交人）
- Evaluation -> Workflow: 多对一
- Evaluation -> User: 多对一（评估人）
- RollbackRequest -> Workflow: 多对一
- RollbackRequest -> Form: 多对一（目标表单）
- RollbackRequest -> User: 多对一（申请人、审批人）
- StepLog -> Form: 多对一
- StepLog -> User: 多对一（操作人）

## 4. 核心功能模块

### 4.1 认证模块 (auth)

#### JWT认证机制
- 使用 `python-jose` 库实现JWT令牌生成和验证
- 令牌有效期：24小时（可配置）
- 密码使用 Bcrypt 加密存储

#### 权限控制
提供三个权限装饰器：
- `require_admin`: 需要管理员权限
- `require_restorer`: 需要修复专家权限
- `require_evaluator`: 需要评估专家权限

### 4.2 工作流管理

#### 工作流生命周期
1. **草稿 (draft)**: 初始创建状态
2. **运行中 (running)**: 提交第一个表单后
3. **已完成 (finished)**: 设置最终方案后
4. **已撤销 (revoked)**: 工作流被撤销
5. **暂停 (paused)**: 工作流暂停

#### 工作流操作
- 创建工作流
- 提交修复表单（多步骤）
- 设置最终方案
- 申请回溯
- 评估打分

### 4.3 文件管理

#### MinIO集成
- 文件上传到MinIO对象存储
- 支持的图片格式：JPEG, PNG, BMP, TIFF
- 支持的文档格式：PDF, Word, TXT
- 最大文件大小：100MB（可配置）

#### 文件处理流程
1. 接收文件上传
2. 验证文件类型和大小
3. 上传到MinIO
4. 返回文件URL
5. 保存URL到数据库

### 4.4 评估系统

#### 评估流程
1. 工作流完成后进入评估阶段
2. 评估专家进行打分（0-100分）
3. 提供评价意见和支撑文件
4. 一个评估专家只能对同一工作流评估一次

### 4.5 回溯机制

#### 回溯流程
1. 修复专家申请回溯到某个历史表单
2. 管理员审批回溯申请
3. 批准后创建新的表单副本
4. 工作流状态重新变为运行中

## 5. API设计原则

### 5.1 RESTful规范
- 使用标准HTTP方法：GET, POST, PUT, DELETE
- 资源路径使用复数形式
- 使用UUID作为资源标识符
- 返回适当的HTTP状态码

### 5.2 响应格式
统一的响应格式：
```json
{
    "success": true,
    "message": "操作成功",
    "data": {}
}
```

### 5.3 错误处理
- 400: 请求参数错误
- 401: 未认证
- 403: 无权限
- 404: 资源不存在
- 500: 服务器内部错误

## 6. 安全措施

### 6.1 认证安全
- JWT令牌加密
- 密码Bcrypt加密
- 令牌过期机制
- Bearer Token认证

### 6.2 数据安全
- SQL注入防护（使用ORM）
- XSS防护（数据验证）
- CORS配置
- 文件类型验证
- 文件大小限制

### 6.3 权限控制
- 基于角色的访问控制(RBAC)
- API级别的权限验证
- 资源级别的权限检查

## 7. 性能优化

### 7.1 数据库优化
- 使用索引优化查询
- 分页查询
- 懒加载关联数据
- 连接池管理

### 7.2 缓存策略
- Redis缓存热点数据
- 静态文件缓存
- API响应缓存

### 7.3 异步处理
- FastAPI异步支持
- 文件上传异步处理
- 数据库异步查询

## 8. 部署配置

### 8.1 环境变量
通过 `.env` 文件配置：
- 数据库连接
- MinIO配置
- Redis配置
- JWT密钥
- 端口配置

### 8.2 Docker部署
提供 `docker-compose.yml` 配置：
- PostgreSQL容器
- MinIO容器
- Redis容器
- 应用容器

### 8.3 服务端口
- 应用端口：8080
- 管理端口：8081
- MinIO端口：9000
- PostgreSQL端口：5432
- Redis端口：6379

## 9. 开发规范

### 9.1 代码规范
- 遵循PEP 8 Python编码规范
- 使用类型注解
- 编写文档字符串
- 模块化设计

### 9.2 Git工作流
- 主分支：main
- 开发分支：develop
- 功能分支：feature/xxx
- 修复分支：bugfix/xxx

### 9.3 测试规范
- 单元测试覆盖核心功能
- API集成测试
- 性能测试
- 安全测试

## 10. 监控和日志

### 10.1 日志记录
- 操作日志记录到数据库
- 系统日志输出到文件
- 错误日志单独记录
- 日志级别可配置

### 10.2 监控指标
- API响应时间
- 数据库查询性能
- 文件上传成功率
- 用户活跃度统计

## 11. 维护和升级

### 11.1 数据库迁移
- 使用Alembic进行数据库版本管理
- 支持升级和回滚
- 迁移脚本版本控制

### 11.2 备份策略
- 数据库定期备份
- MinIO文件备份
- 配置文件备份
- 灾难恢复计划

## 12. 常见问题

### 12.1 开发环境搭建
1. 安装Python 3.8+
2. 安装PostgreSQL
3. 安装MinIO
4. 安装Redis
5. 安装依赖：`pip install -r requirements.txt`
6. 初始化数据库：运行 `main.py`

### 12.2 默认账号
- 管理员：admin / admin123
- 修复专家：restorer1 / 123456
- 评估专家：evaluator1 / 123456

### 12.3 调试技巧
- 使用FastAPI自动生成的文档：http://localhost:8080/docs
- 查看Swagger UI进行API测试
- 使用日志调试
- 使用断点调试

## 13. 版本历史

### v1.2.0 (当前版本) - 2025年1月
- 修复回溯申请数据获取问题
- 优化审批API格式（JSON替代Form-Data）
- 添加分页和搜索功能支持
- 修复前端TDesign组件DOM引用错误
- 改进错误处理和响应格式
- 优化数据加载和统计计算逻辑

#### 回溯申请接口更新详情
1. **获取回溯申请列表** (`GET /api/rollback-requests`)
   - 新增分页支持：`page`、`limit` 参数
   - 新增搜索功能：`search` 参数（支持申请人姓名、申请原因、工作流ID）
   - 新增状态筛选：`status` 参数
   - 响应格式改为分页结构：`RollbackRequestPaginatedResponse`

2. **审批回溯申请** (`POST /api/rollback-requests/{rollback_id}/approve`)
   - 请求格式从Form-Data改为JSON
   - 新增审批意见字段：`comment`
   - 使用 `RollbackRequestApprove` 数据模型

3. **数据模型更新**
   - `RollbackRequestApprove`: 审批请求模型
   - `RollbackRequestPaginatedResponse`: 分页响应模型
   - `RollbackRequestResponse`: 回溯申请响应模型

### v1.1.0 - 2025年1月
- 新增删除历史记录功能
- 实现软删除和硬删除机制
- 添加批量删除功能
- 完善权限控制和安全特性

### v1.0.0 - 2024年12月
- 基础功能实现
- 用户认证系统
- 工作流管理
- 文件上传
- 评估系统
- 回溯机制
