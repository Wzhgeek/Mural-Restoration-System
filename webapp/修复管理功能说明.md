# 修复管理功能说明

## 概述

修复管理页面是克孜尔石窟壁画智慧修复全生命周期管理系统的核心管理模块，专为管理员设计，提供全面的工作流和回溯申请管理功能。

## 功能特性

### 1. 工作流管理
- **查看所有工作流**：显示系统中所有修复工作流的详细信息
- **工作流详情**：点击"查看"按钮可查看工作流的完整信息，包括：
  - 基本信息（标题、发起人、状态、步骤等）
  - 修复表单历史（所有提交的表单记录）
  - 评估意见（专家评估结果）
- **删除工作流**：管理员可以删除不需要的工作流
- **批量删除**：支持选择多个工作流进行批量删除操作

### 2. 回溯申请管理
- **查看回溯申请**：显示所有回溯申请的状态和详情
- **审批功能**：管理员可以批准或拒绝回溯申请
- **申请详情**：点击"查看详情"可查看完整的申请信息
- **删除申请**：管理员可以删除回溯申请记录
- **批量操作**：支持批量删除回溯申请

### 3. 统计仪表板
- **总工作流数**：显示系统中工作流的总数量
- **进行中工作流**：显示当前正在处理的工作流数量
- **已完成工作流**：显示已完成的工作流数量
- **待评估工作流**：显示等待专家评估的工作流数量
- **待审批回溯**：显示等待管理员审批的回溯申请数量
- **完成率**：显示工作流的整体完成率

### 4. 搜索和筛选
- **工作流搜索**：支持按标题、发起人搜索工作流
- **状态筛选**：支持按工作流状态筛选（草稿、进行中、已完成、已暂停、已撤销）
- **回溯申请搜索**：支持按申请原因、工作流ID搜索回溯申请
- **状态筛选**：支持按申请状态筛选（待审批、已批准、已拒绝）

## 技术实现

### API接口
- **工作流管理**：`/workflows` - 获取工作流列表
- **回溯申请管理**：`/rollback-requests` - 获取回溯申请列表（支持分页和搜索）
- **统计数据**：`/dashboard` - 获取管理统计数据
- **删除操作**：`/admin/workflows/{id}` - 删除工作流
- **审批操作**：`/rollback-requests/{id}/approve` - 审批回溯申请（JSON格式）

## 最新更新（2025年1月）

### 修复内容
1. **回溯申请数据获取问题修复**
   - 修复了待审批回溯申请无法正确获取数据的问题
   - 更新了后端API以支持分页、搜索和状态筛选
   - 修复了前端数据处理逻辑

2. **审批API格式优化**
   - 修复了审批回溯申请时的422错误
   - 将审批API从Form-Data格式改为JSON格式
   - 添加了审批意见字段支持

3. **API响应格式改进**
   - 回溯申请列表API现在返回分页信息
   - 支持按申请人姓名、申请原因、工作流ID进行搜索
   - 改进了错误处理和响应格式

4. **前端组件优化**
   - 修复了TDesign组件的DOM引用错误
   - 优化了数据加载和统计计算逻辑
   - 改进了错误处理机制

### 数据字段映射
根据数据库表结构，正确映射以下字段：
- **工作流状态**：draft（草稿）、running（进行中）、finished（已完成）、paused（已暂停）、revoked（已撤销）
- **回溯申请状态**：pending（待审批）、approved（已批准）、rejected（已拒绝）
- **用户信息**：initiator_name（发起人）、requester_name（申请人）

### 权限控制
- 只有管理员（role_key: 'admin'）可以访问此页面
- 所有删除和审批操作都需要管理员权限
- 前端进行权限检查，后端进行最终权限验证

## 使用方法

### 1. 访问页面
- 确保已登录且具有管理员权限
- 在侧边栏点击"修复管理"菜单

### 2. 管理工作流
1. 在左侧工作流列表中查看所有工作流
2. 使用搜索框和状态筛选器快速找到目标工作流
3. 点击"查看"按钮查看工作流详情
4. 选择工作流后点击"删除"按钮删除单个工作流
5. 勾选多个工作流后点击"批量删除"按钮进行批量操作

### 3. 管理回溯申请
1. 在右侧回溯申请列表中查看所有申请
2. 使用搜索和筛选功能快速定位申请
3. 点击"查看详情"查看完整的申请信息
4. 对于待审批的申请，点击"批准"或"拒绝"按钮进行审批
5. 管理员可以删除任何回溯申请记录

### 4. 查看统计信息
- 页面顶部的统计卡片显示关键指标
- 数据实时更新，反映系统当前状态

## 注意事项

1. **数据安全**：所有删除操作都是不可逆的，请谨慎操作
2. **权限管理**：确保只有授权管理员可以访问此页面
3. **网络连接**：确保前端与后端服务器（localhost:8080）连接正常
4. **数据同步**：操作完成后会自动刷新数据，确保显示最新状态

## 故障排除

### 常见问题
1. **页面无法加载**：检查后端服务器是否启动（端口8080）
2. **数据不显示**：检查网络连接和API接口状态
3. **权限错误**：确认用户具有管理员权限
4. **操作失败**：查看浏览器控制台错误信息

### 调试工具
- 使用浏览器开发者工具查看网络请求
- 运行 `testApiConnection()` 函数测试API连接
- 检查控制台错误日志

## 更新日志

### v1.0 (2025年)
- 初始版本发布
- 实现基本的工作流和回溯申请管理功能
- 添加统计仪表板和搜索筛选功能
- 完善权限控制和错误处理

---

**作者**：王梓涵  
**邮箱**：wangzh011031@163.com  
**日期**：2025年
