# 回溯历史功能说明

## 功能概述

回溯历史功能用于查看和管理系统中的回溯申请记录，包括申请状态、审批流程等。

## 主要功能

### 1. 数据展示
- **申请列表**: 显示所有回溯申请记录
- **状态筛选**: 支持按审批状态筛选（待审批、已批准、已拒绝）
- **搜索功能**: 支持按申请ID、工作流ID、申请人等关键词搜索
- **时间筛选**: 支持按申请时间范围筛选

### 2. 权限控制
- **管理员**: 可以查看所有回溯申请，进行审批操作，强制删除任何记录，批量删除
- **修复专家**: 可以查看自己提交的回溯申请，删除自己待审批状态的申请
- **评估专家**: 只能查看回溯申请记录，无操作权限

### 3. 操作功能
- **查看详情**: 查看回溯申请的完整信息
- **审批操作**: 管理员可以批准或拒绝待审批的申请
- **删除记录**: 
  - 管理员：可以强制删除任何状态的申请记录
  - 修复专家：只能删除自己提交的待审批状态申请
- **批量操作**: 管理员支持批量删除选中的记录（最多100条）

## 数据字段说明

根据数据库表结构，回溯申请包含以下字段：

| 字段名 | 类型 | 说明 |
|--------|------|------|
| rollback_id | SERIAL | 回溯申请主键 |
| workflow_id | UUID | 所属工作流ID |
| requester_id | INT | 申请人ID |
| target_form_id | UUID | 回滚到的目标表单ID |
| reason | TEXT | 回溯原因 |
| status | VARCHAR(20) | 审批状态：pending/approved/rejected |
| approver_id | INT | 管理员审批人ID |
| approved_at | TIMESTAMPTZ | 审批时间 |
| created_at | TIMESTAMPTZ | 申请时间 |

## 统计指标说明

### 批准率计算
批准率 = 已批准申请数 / 已处理申请数 × 100%

其中：
- 已处理申请数 = 已批准申请数 + 已拒绝申请数

## 最新更新

### 修复内容
1. **数据获取问题修复**
   - 修复了回溯申请列表无法正确获取数据的问题
   - 更新了API响应格式以支持分页数据
   - 优化了前端数据处理逻辑

2. **审批功能优化**
   - 修复了审批回溯申请时的422错误
   - 将审批API从Form-Data格式改为JSON格式
   - 添加了审批意见字段支持

3. **前端组件问题修复**
   - 修复了TDesign组件的DOM引用错误
   - 优化了数据加载和统计计算逻辑
   - 改进了错误处理机制

4. **API功能增强**
   - 支持按申请人姓名、申请原因、工作流ID进行搜索
   - 添加了分页功能支持
   - 改进了错误处理和响应格式

### 接口更新详情

#### 获取回溯申请列表 (`GET /api/rollback-requests`)
**新增参数**：
- `page`: 页码（默认1）
- `limit`: 每页数量（默认20）
- `search`: 搜索关键词（支持申请人姓名、申请原因、工作流ID）
- `status`: 状态筛选（pending/approved/rejected/all）

**响应格式**：
```json
{
    "items": [...],           // 回溯申请列表
    "total": 25,             // 总记录数
    "page": 1,               // 当前页码
    "limit": 20,             // 每页数量
    "total_pages": 2         // 总页数
}
```

#### 审批回溯申请 (`POST /api/rollback-requests/{rollback_id}/approve`)
**请求格式**（JSON）：
```json
{
    "approve": true,         // 是否批准
    "comment": "审批意见"     // 审批意见（可选）
}
```

**数据模型**：
- `RollbackRequestApprove`: 审批请求模型
- `RollbackRequestPaginatedResponse`: 分页响应模型
- `RollbackRequestResponse`: 回溯申请响应模型
- 待审批申请不计入已处理申请数

**示例**：
- 总申请数：100
- 待审批：20
- 已批准：60
- 已拒绝：20
- 批准率 = 60 / (60 + 20) × 100% = 75%

## API接口说明

### 1. 获取回溯历史列表
```
GET /api/rollback-requests
参数:
- search: 搜索关键词
- status: 状态筛选
- date_range: 时间范围
- page: 页码
- limit: 每页数量
```

### 2. 获取回溯详情
```
GET /api/rollback-requests/{rollback_id}
```

### 3. 审批回溯申请
```
POST /api/rollback-requests/{rollback_id}/approve
参数:
- approve: boolean (true批准，false拒绝)
- comment: 审批意见（可选）
```

### 4. 删除回溯记录

#### 4.1 普通用户删除
```
DELETE /api/rollback-requests/{rollback_id}
```
- 只能删除自己提交的申请
- 只能删除待审批状态的申请

#### 4.2 管理员强制删除
```
DELETE /api/admin/rollback-requests/{rollback_id}
```
- 可以删除任何申请记录
- 不受状态限制

#### 4.3 管理员批量删除
```
POST /api/admin/rollback-requests/batch-delete
请求体: {"ids": [1, 2, 3, 4, 5]}
```
- 批量删除数量不能超过100条
- 只有管理员可以使用

## 使用说明

### 1. 查看回溯历史
1. 登录系统后，点击左侧菜单"回溯历史"
2. 系统会自动加载所有回溯申请记录
3. 可以使用搜索框和筛选器来查找特定记录

### 2. 审批回溯申请（仅管理员）
1. 在回溯历史列表中找到状态为"待审批"的记录
2. 点击"详情"按钮查看申请详情
3. 在详情页面点击"批准"或"拒绝"按钮
4. 输入审批意见（可选）
5. 确认操作

### 3. 删除回溯记录

#### 3.1 单个删除
- **管理员**: 可以删除任何记录，点击"删除"按钮即可
- **修复专家**: 只能删除自己提交的待审批状态申请

#### 3.2 批量删除（仅管理员）
1. 选择要删除的记录（可多选，最多100条）
2. 点击"批量删除"按钮
3. 确认删除操作

## 注意事项

1. **权限控制**: 
   - 管理员：可以进行审批和删除操作
   - 修复专家：只能删除自己提交的待审批申请
   - 评估专家：无删除权限
2. **数据安全**: 删除操作不可撤销，请谨慎操作
3. **删除限制**: 
   - 普通用户只能删除待审批状态的申请
   - 批量删除最多100条记录
   - 软删除机制，可通过数据库恢复
4. **网络连接**: 确保网络连接正常，API接口地址为 `http://localhost:8080`
5. **错误处理**: 如果API接口不可用，系统会显示相应的错误提示

## 技术实现

- **前端框架**: Vue 3 + TDesign
- **状态管理**: 使用Vue 3 Composition API
- **HTTP请求**: 基于axios的request封装
- **权限控制**: 基于localStorage中的用户角色信息
- **错误处理**: 统一的错误提示和异常处理机制

## 开发说明

### 文件结构
```
webapp/src/
├── views/
│   └── RollbackHistory.vue    # 回溯历史页面组件
├── api/
│   ├── rollback.js           # 回溯相关API接口
│   └── rollback-test.js      # API测试文件
└── components/
    └── Layout.vue            # 布局组件
```

### 主要组件说明
- **RollbackHistory.vue**: 主要的回溯历史页面组件，包含数据展示、筛选、操作等功能
- **rollback.js**: API接口封装，包含所有与回溯相关的HTTP请求
- **Layout.vue**: 页面布局组件，提供统一的页面结构

### 开发调试
1. 确保后端服务运行在 `http://localhost:8080`
2. 使用浏览器开发者工具查看网络请求
3. 检查控制台日志获取详细的错误信息
4. 可以使用 `rollback-test.js` 进行API接口测试

## 更新日志

### v1.0.0 (2025-01-XX)
- 初始版本发布
- 实现基本的回溯历史查看功能
- 支持权限控制和操作功能
- 集成真实的API接口
- 完善错误处理机制
