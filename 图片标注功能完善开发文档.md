# 图片标注功能完善开发文档

## 作者信息
- **作者**: 王梓涵
- **邮箱**: wangzh011031@163.com
- **项目**: 克孜尔石窟壁画智慧修复全生命周期管理系统
- **日期**: 2025年

## 📋 功能概述

本文档旨在完善修复提交流程中的图片标注功能，提升壁画修复专业人员的标注体验，使其能够更精确、高效地标注壁画损坏区域和修复要点。

## 🎯 当前功能分析

### 现有功能
- ✅ 基础绘制工具：选择、画笔、文字、矩形
- ✅ 画笔属性设置：颜色、粗细
- ✅ 撤销/重做功能
- ✅ 清除画布功能
- ✅ 编辑结果保存
- ✅ 基于Fabric.js的画布实现

### 功能不足
- ❌ 标注工具种类有限，缺少专业标注工具
- ❌ 没有图层管理功能
- ❌ 属性设置面板功能简单
- ❌ 缺少测量工具
- ❌ 没有标注模板和预设
- ❌ 缺少导出和报告功能
- ❌ 用户体验有待优化

## 🚀 完善计划

### 1. 增强标注工具栏

#### 1.1 新增绘制工具
```javascript
// 新增工具类型
const TOOL_TYPES = {
  // 现有工具
  SELECT: 'select',
  DRAW: 'draw', 
  TEXT: 'text',
  RECTANGLE: 'rectangle',
  
  // 新增工具
  ARROW: 'arrow',           // 箭头标注
  CIRCLE: 'circle',         // 圆形标注
  ELLIPSE: 'ellipse',       // 椭圆标注
  POLYGON: 'polygon',       // 多边形标注
  LINE: 'line',             // 直线标注
  CURVE: 'curve',           // 曲线标注
  HIGHLIGHTER: 'highlighter', // 荧光笔
  ERASER: 'eraser',         // 橡皮擦
  MAGNIFIER: 'magnifier',   // 放大镜
  RULER: 'ruler',           // 测量尺
  PROTRACTOR: 'protractor'  // 量角器
}
```

#### 1.2 专业标注工具
- **损坏区域标注**: 用不同颜色和样式标注不同类型的损坏
- **修复建议标注**: 添加修复方案的文字和图形说明
- **重点关注区域**: 高亮显示需要特别注意的区域
- **对比标注**: 修复前后对比的标注工具

### 2. 图层管理系统

#### 2.1 图层面板设计
```vue
<template>
  <div class="layer-panel">
    <div class="layer-header">
      <h4>图层管理</h4>
      <t-button size="small" @click="addLayer">
        <template #icon><t-icon name="add" /></template>
        新建图层
      </t-button>
    </div>
    
    <div class="layer-list">
      <div 
        v-for="layer in layers" 
        :key="layer.id"
        :class="['layer-item', { active: layer.id === activeLayerId }]"
        @click="selectLayer(layer.id)"
      >
        <div class="layer-controls">
          <t-checkbox 
            v-model="layer.visible"
            @change="toggleLayerVisibility(layer.id)"
          />
          <t-button 
            size="small"
            :theme="layer.locked ? 'warning' : 'default'"
            @click="toggleLayerLock(layer.id)"
          >
            <t-icon :name="layer.locked ? 'lock' : 'lock-off'" />
          </t-button>
        </div>
        
        <div class="layer-info">
          <input 
            v-model="layer.name"
            class="layer-name"
            @blur="updateLayerName(layer.id, layer.name)"
          />
          <div class="layer-opacity">
            <t-slider 
              v-model="layer.opacity"
              :min="0"
              :max="100"
              @change="updateLayerOpacity(layer.id, layer.opacity)"
            />
          </div>
        </div>
        
        <t-button 
          size="small"
          theme="danger"
          @click="deleteLayer(layer.id)"
        >
          <t-icon name="delete" />
        </t-button>
      </div>
    </div>
  </div>
</template>
```

#### 2.2 图层功能
- **图层创建/删除**: 动态管理标注图层
- **显示/隐藏**: 控制图层可见性
- **锁定/解锁**: 防止误操作
- **透明度调节**: 调整图层透明度
- **图层重命名**: 自定义图层名称
- **图层排序**: 拖拽调整图层顺序

### 3. 属性设置面板

#### 3.1 详细属性控制
```vue
<template>
  <div class="properties-panel">
    <!-- 通用属性 -->
    <t-collapse v-model="activePanel">
      <t-collapse-panel header="基础属性" value="basic">
        <div class="property-group">
          <label>颜色:</label>
          <t-color-picker v-model="currentStyle.color" />
          
          <label>透明度:</label>
          <t-slider v-model="currentStyle.opacity" :min="0" :max="100" />
          
          <label>线条粗细:</label>
          <t-input-number v-model="currentStyle.strokeWidth" :min="1" :max="50" />
        </div>
      </t-collapse-panel>
      
      <!-- 文字属性 -->
      <t-collapse-panel header="文字属性" value="text" v-if="selectedObject?.type === 'text'">
        <div class="property-group">
          <label>字体:</label>
          <t-select v-model="textStyle.fontFamily" :options="fontOptions" />
          
          <label>字号:</label>
          <t-input-number v-model="textStyle.fontSize" :min="8" :max="72" />
          
          <label>字体样式:</label>
          <t-checkbox-group v-model="textStyle.styles">
            <t-checkbox value="bold">粗体</t-checkbox>
            <t-checkbox value="italic">斜体</t-checkbox>
            <t-checkbox value="underline">下划线</t-checkbox>
          </t-checkbox-group>
        </div>
      </t-collapse-panel>
      
      <!-- 形状属性 -->
      <t-collapse-panel header="形状属性" value="shape" v-if="isShapeObject">
        <div class="property-group">
          <label>填充颜色:</label>
          <t-color-picker v-model="shapeStyle.fill" />
          
          <label>边框样式:</label>
          <t-select v-model="shapeStyle.strokeDashArray" :options="strokeOptions" />
          
          <label>圆角:</label>
          <t-slider v-model="shapeStyle.rx" :min="0" :max="50" />
        </div>
      </t-collapse-panel>
    </t-collapse>
  </div>
</template>
```

### 4. 测量工具系统

#### 4.1 距离测量
```javascript
// 距离测量工具
class DistanceMeasureTool {
  constructor(canvas) {
    this.canvas = canvas
    this.isActive = false
    this.startPoint = null
    this.measureLine = null
  }
  
  activate() {
    this.isActive = true
    this.canvas.on('mouse:down', this.onMouseDown.bind(this))
    this.canvas.on('mouse:move', this.onMouseMove.bind(this))
    this.canvas.on('mouse:up', this.onMouseUp.bind(this))
  }
  
  onMouseDown(event) {
    const pointer = this.canvas.getPointer(event.e)
    this.startPoint = pointer
    
    // 创建测量线
    this.measureLine = new fabric.Line([
      pointer.x, pointer.y, pointer.x, pointer.y
    ], {
      stroke: '#ff6b35',
      strokeWidth: 2,
      strokeDashArray: [5, 5],
      selectable: false,
      evented: false
    })
    
    this.canvas.add(this.measureLine)
  }
  
  onMouseMove(event) {
    if (!this.measureLine || !this.startPoint) return
    
    const pointer = this.canvas.getPointer(event.e)
    this.measureLine.set({
      x2: pointer.x,
      y2: pointer.y
    })
    
    // 计算距离
    const distance = this.calculateDistance(this.startPoint, pointer)
    this.updateDistanceLabel(distance)
    
    this.canvas.renderAll()
  }
  
  calculateDistance(point1, point2) {
    const dx = point2.x - point1.x
    const dy = point2.y - point1.y
    return Math.sqrt(dx * dx + dy * dy)
  }
}
```

#### 4.2 角度测量
```javascript
// 角度测量工具
class AngleMeasureTool {
  constructor(canvas) {
    this.canvas = canvas
    this.points = []
    this.lines = []
  }
  
  measureAngle(point1, vertex, point2) {
    const angle1 = Math.atan2(point1.y - vertex.y, point1.x - vertex.x)
    const angle2 = Math.atan2(point2.y - vertex.y, point2.x - vertex.x)
    let angle = Math.abs(angle2 - angle1)
    
    if (angle > Math.PI) {
      angle = 2 * Math.PI - angle
    }
    
    return (angle * 180) / Math.PI
  }
}
```

#### 4.3 面积测量
```javascript
// 面积测量工具
class AreaMeasureTool {
  constructor(canvas) {
    this.canvas = canvas
    this.polygon = null
    this.points = []
  }
  
  calculatePolygonArea(points) {
    let area = 0
    const n = points.length
    
    for (let i = 0; i < n; i++) {
      const j = (i + 1) % n
      area += points[i].x * points[j].y
      area -= points[j].x * points[i].y
    }
    
    return Math.abs(area) / 2
  }
}
```

### 5. 标注模板系统

#### 5.1 预设模板
```javascript
// 标注模板定义
const ANNOTATION_TEMPLATES = {
  DAMAGE_ASSESSMENT: {
    name: '损坏评估模板',
    tools: ['circle', 'arrow', 'text'],
    presets: {
      severe: { color: '#ff4757', opacity: 0.7, strokeWidth: 3 },
      moderate: { color: '#ffa502', opacity: 0.7, strokeWidth: 2 },
      minor: { color: '#2ed573', opacity: 0.7, strokeWidth: 1 }
    }
  },
  
  RESTORATION_PLAN: {
    name: '修复方案模板',
    tools: ['rectangle', 'polygon', 'text', 'arrow'],
    presets: {
      cleaning: { color: '#3742fa', opacity: 0.5 },
      reinforcement: { color: '#f8b500', opacity: 0.5 },
      inpainting: { color: '#e55039', opacity: 0.5 }
    }
  },
  
  DOCUMENTATION: {
    name: '文档记录模板',
    tools: ['text', 'ruler', 'magnifier'],
    presets: {
      measurement: { color: '#000000', fontSize: 12 },
      note: { color: '#2c2c54', fontSize: 14 },
      title: { color: '#40407a', fontSize: 18, fontWeight: 'bold' }
    }
  }
}
```

### 6. 用户体验优化

#### 6.1 快捷键支持
```javascript
// 快捷键配置
const KEYBOARD_SHORTCUTS = {
  'Ctrl+Z': 'undo',
  'Ctrl+Y': 'redo', 
  'Ctrl+S': 'save',
  'Delete': 'deleteSelected',
  'Escape': 'deselectAll',
  'Ctrl+A': 'selectAll',
  'Ctrl+C': 'copy',
  'Ctrl+V': 'paste',
  'S': 'selectTool',
  'D': 'drawTool',
  'T': 'textTool',
  'R': 'rectangleTool',
  'C': 'circleTool',
  'A': 'arrowTool'
}
```

#### 6.2 右键菜单
```vue
<template>
  <div 
    v-show="contextMenu.visible"
    class="context-menu"
    :style="{ left: contextMenu.x + 'px', top: contextMenu.y + 'px' }"
  >
    <div class="menu-item" @click="copyObject">复制</div>
    <div class="menu-item" @click="pasteObject">粘贴</div>
    <div class="menu-divider"></div>
    <div class="menu-item" @click="bringToFront">置于顶层</div>
    <div class="menu-item" @click="sendToBack">置于底层</div>
    <div class="menu-divider"></div>
    <div class="menu-item" @click="deleteObject">删除</div>
    <div class="menu-item" @click="duplicateObject">复制对象</div>
  </div>
</template>
```

### 7. 导出功能

#### 7.1 标注数据导出
```javascript
// 导出标注数据
class AnnotationExporter {
  constructor(canvas) {
    this.canvas = canvas
  }
  
  // 导出为JSON格式
  exportToJSON() {
    const canvasData = this.canvas.toJSON()
    const annotations = this.extractAnnotations(canvasData)
    
    return {
      version: '1.0',
      timestamp: new Date().toISOString(),
      imageInfo: this.getImageInfo(),
      annotations: annotations,
      metadata: this.getMetadata()
    }
  }
  
  // 导出为PDF报告
  async exportToPDF() {
    const { jsPDF } = await import('jspdf')
    const doc = new jsPDF()
    
    // 添加标题
    doc.setFontSize(16)
    doc.text('壁画标注报告', 20, 20)
    
    // 添加图片
    const imageData = this.canvas.toDataURL()
    doc.addImage(imageData, 'PNG', 20, 40, 170, 120)
    
    // 添加标注统计
    const stats = this.getAnnotationStats()
    doc.setFontSize(12)
    doc.text(`标注总数: ${stats.total}`, 20, 180)
    doc.text(`损坏区域: ${stats.damage}`, 20, 190)
    doc.text(`修复建议: ${stats.restoration}`, 20, 200)
    
    return doc
  }
}
```

## 🛠️ 技术实现

### 技术栈
- **前端框架**: Vue 3 + Composition API
- **UI组件库**: TDesign Vue Next
- **画布库**: Fabric.js 5.x
- **状态管理**: Pinia
- **构建工具**: Vite

### 核心依赖
```json
{
  "fabric": "^5.3.0",
  "jspdf": "^2.5.1",
  "html2canvas": "^1.4.1",
  "file-saver": "^2.0.5"
}
```

## 📁 文件结构

```
webapp/src/
├── components/
│   └── ImageAnnotation/
│       ├── AnnotationCanvas.vue      # 主画布组件
│       ├── ToolBar.vue              # 工具栏组件
│       ├── LayerPanel.vue           # 图层面板
│       ├── PropertiesPanel.vue      # 属性面板
│       ├── TemplateSelector.vue     # 模板选择器
│       └── ExportDialog.vue         # 导出对话框
├── composables/
│   └── useAnnotation.js             # 标注功能组合式API
├── utils/
│   ├── annotationTools.js           # 标注工具类
│   ├── measurementTools.js          # 测量工具类
│   └── exportUtils.js               # 导出工具类
└── stores/
    └── annotationStore.js           # 标注状态管理
```

## 🎨 设计规范

### 颜色规范
```css
:root {
  /* 主色调 */
  --annotation-primary: #1890ff;
  --annotation-success: #52c41a;
  --annotation-warning: #faad14;
  --annotation-error: #ff4d4f;
  
  /* 标注专用色 */
  --damage-severe: #ff4757;
  --damage-moderate: #ffa502;
  --damage-minor: #2ed573;
  
  /* 工具色 */
  --tool-active: #1890ff;
  --tool-hover: #40a9ff;
  --tool-disabled: #d9d9d9;
}
```

### 交互规范
- **工具切换**: 点击工具按钮立即切换，高亮显示当前工具
- **对象选择**: 单击选择，双击编辑，拖拽移动
- **多选操作**: Ctrl+点击多选，Shift+拖拽框选
- **右键菜单**: 在对象上右键显示上下文菜单

## 📊 性能优化

### 渲染优化
- **虚拟化渲染**: 大量标注对象时使用虚拟化
- **分层渲染**: 将静态背景和动态标注分层
- **懒加载**: 工具和面板按需加载

### 内存管理
- **对象池**: 复用标注对象，减少GC压力
- **事件清理**: 组件销毁时清理事件监听
- **图片压缩**: 大图片自动压缩处理

## 🧪 测试计划

### 功能测试
- [ ] 所有标注工具正常工作
- [ ] 图层管理功能完整
- [ ] 属性面板响应正确
- [ ] 测量工具精度验证
- [ ] 导出功能完整性

### 性能测试
- [ ] 大图片加载性能
- [ ] 大量标注对象渲染性能
- [ ] 内存使用情况监控

### 兼容性测试
- [ ] 主流浏览器兼容性
- [ ] 移动端适配
- [ ] 不同屏幕分辨率适配

## 🚀 实施计划

### 第一阶段（高优先级）
1. 完善工具栏，增加箭头、圆形、多边形等工具
2. 实现图层管理基础功能
3. 优化属性设置面板

### 第二阶段（中优先级）
1. 实现测量工具系统
2. 添加标注模板功能
3. 优化用户体验

### 第三阶段（低优先级）
1. 完善导出功能
2. 性能优化
3. 测试和文档完善

## 📝 总结

通过以上完善计划，图片标注功能将从基础的绘制工具升级为专业的壁画标注系统，能够满足文物修复专家的专业需求，提供精确、高效的标注体验。整个系统将保持简洁专业的界面设计，确保功能完整性的同时不影响用户体验。