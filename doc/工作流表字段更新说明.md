# 工作流表字段更新说明

## 概述

本次更新在`workflows`表中添加了`user_id`和`username`字段，以提供更灵活的用户关联和查询功能。

## 更新内容

### 1. 数据库表结构更新

在`workflows`表中新增以下字段：

- `user_id` (INTEGER, 可空) - 用户ID字段，关联users表
- `username` (VARCHAR(50), 可空) - 用户名字段，便于快速查询

### 2. 索引优化

为新增字段创建了相应的索引：

- `idx_workflows_user_id` - 提高按用户ID查询的性能
- `idx_workflows_username` - 提高按用户名查询的性能

### 3. 数据模型更新

更新了SQLAlchemy模型定义：

- `Workflow`模型新增`user_id`和`username`字段
- 添加了相应的关系映射
- 更新了`User`模型的关系定义

## 文件修改清单

### 数据库相关文件

1. **database_schema.sql**
   - 更新workflows表定义
   - 添加新字段的索引

2. **migrate_workflow_user_fields.py** (新增)
   - 数据库迁移脚本
   - 自动添加字段并填充数据

3. **migrate_workflow_fields.bat** (新增)
   - Windows批处理文件，方便执行迁移

### 模型文件

4. **app/models/models.py**
   - 更新Workflow模型定义
   - 添加user关系映射
   - 更新User模型的关系定义

## 使用方法

### 执行迁移

1. **使用批处理文件（推荐）**：
   ```bash
   migrate_workflow_fields.bat
   ```

2. **直接运行Python脚本**：
   ```bash
   python migrate_workflow_user_fields.py
   ```

### 迁移过程

迁移脚本将执行以下步骤：

1. 测试数据库连接
2. 检查workflows表结构
3. 添加user_id和username字段
4. 从initiator_id关联的users表获取username数据
5. 为新增字段创建索引
6. 验证迁移结果

## 字段说明

### user_id字段

- **类型**: INTEGER
- **约束**: 外键关联users.user_id
- **可空**: 是
- **用途**: 提供额外的用户关联，与initiator_id形成互补

### username字段

- **类型**: VARCHAR(50)
- **可空**: 是
- **用途**: 存储用户名，便于快速查询和显示，避免频繁JOIN操作

## 数据填充策略

迁移脚本会自动：

1. 将`initiator_id`的值复制到`user_id`字段
2. 通过JOIN查询从users表获取对应的username
3. 确保数据一致性

## 向后兼容性

- 保留了原有的`initiator_id`字段
- 新增字段为可空，不影响现有功能
- 现有API和查询逻辑无需修改

## 性能优化

- 为新增字段创建了索引
- 减少了频繁的JOIN查询需求
- 提高了按用户查询工作流的性能

## 注意事项

1. 执行迁移前请备份数据库
2. 确保数据库连接正常
3. 迁移过程中请勿中断操作
4. 建议在维护窗口期间执行迁移

## 作者信息

- **作者**: 王梓涵
- **邮箱**: wangzh011031@163.com
- **时间**: 2025年

## 版本历史

- **v1.0** (2025年) - 初始版本，添加user_id和username字段
