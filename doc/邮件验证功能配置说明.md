# 邮件验证功能配置说明

## 概述

本文档说明了如何配置邮件验证注册功能的环境变量和相关设置。

## 环境变量配置

### 1. 创建 .env 文件

在项目根目录下创建 `.env` 文件，复制以下内容并根据实际情况修改：

```env
# 克孜尔石窟壁画智慧修复全生命周期管理系统 - 环境配置文件
# 作者: 王梓涵
# 邮箱: wangzh011031@163.com
# 时间: 2025年

# 应用配置
APP_NAME=克孜尔石窟壁画智慧修复全生命周期管理系统
APP_VERSION=1.0.0
DEBUG=true

# 服务端口配置
APP_PORT=8080
ADMIN_PORT=8081

# 数据库配置
POSTGRES_HOST=localhost
POSTGRES_PORT=5432
POSTGRES_DB=repair_system
POSTGRES_USER=postgres
POSTGRES_PASSWORD=postgres123

# MinIO配置
MINIO_ENDPOINT=localhost:9000
MINIO_ACCESS_KEY=minioadmin
MINIO_SECRET_KEY=minioadmin
MINIO_BUCKET=repair-file
MINIO_SECURE=false

# Redis配置
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_DB=0

# JWT配置
SECRET_KEY=kizil-cave-repair-system-secret-key-2024
ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=1440

# 前端配置
VUE_WEB=true

# 文件上传配置
MAX_FILE_SIZE=104857600
ALLOWED_IMAGE_TYPES=image/jpeg,image/png,image/bmp,image/tiff
ALLOWED_FILE_TYPES=application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document,text/plain

# 邮件服务配置
SMTP_HOST=smtp.163.com
SMTP_PORT=587
SMTP_USER=wangzh011031@163.com
SMTP_PASSWORD=your_email_password
SMTP_USE_TLS=true
EMAIL_FROM=wangzh011031@163.com
EMAIL_FROM_NAME=克孜尔石窟壁画智慧修复全生命周期管理系统

# 邮件验证配置
EMAIL_VERIFICATION_CODE_EXPIRE_MINUTES=10
EMAIL_VERIFICATION_CODE_LENGTH=6
```

### 2. 邮件服务配置说明

#### 2.1 163邮箱配置

- **SMTP_HOST**: `smtp.163.com`
- **SMTP_PORT**: `587`
- **SMTP_USE_TLS**: `true`

#### 2.2 其他邮箱服务商配置

**QQ邮箱:**
```env
SMTP_HOST=smtp.qq.com
SMTP_PORT=587
SMTP_USE_TLS=true
```

**Gmail:**
```env
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USE_TLS=true
```

**Outlook:**
```env
SMTP_HOST=smtp-mail.outlook.com
SMTP_PORT=587
SMTP_USE_TLS=true
```

### 3. 邮箱授权码获取

#### 3.1 163邮箱授权码获取步骤

1. 登录163邮箱
2. 进入"设置" -> "POP3/SMTP/IMAP"
3. 开启"SMTP服务"
4. 获取授权码（不是登录密码）
5. 将授权码填入 `SMTP_PASSWORD` 字段

#### 3.2 QQ邮箱授权码获取步骤

1. 登录QQ邮箱
2. 进入"设置" -> "账户"
3. 开启"POP3/SMTP服务"
4. 获取授权码
5. 将授权码填入 `SMTP_PASSWORD` 字段

### 4. 验证码配置

- **EMAIL_VERIFICATION_CODE_EXPIRE_MINUTES**: 验证码有效期（分钟），默认10分钟
- **EMAIL_VERIFICATION_CODE_LENGTH**: 验证码长度，默认6位数字

## 功能特性

### 1. 邮箱验证流程

1. 用户输入邮箱地址
2. 系统发送验证码到邮箱
3. 用户输入验证码
4. 系统验证验证码
5. 验证成功后完成注册

### 2. 安全特性

- 验证码有效期限制（默认10分钟）
- 验证码尝试次数限制（最多5次）
- 验证码自动过期清理
- 邮箱格式验证
- 防重复注册检查

### 3. 邮件模板

- 验证码邮件：包含6位数字验证码，有效期提示
- 欢迎邮件：注册成功后的欢迎信息

## API接口

### 1. 发送验证码

**POST** `/api/email/send-verification`

请求体：
```json
{
    "email": "user@example.com"
}
```

响应：
```json
{
    "success": true,
    "message": "验证码已发送到 user@example.com，请查收邮件",
    "email": "user@example.com"
}
```

### 2. 验证验证码

**POST** `/api/email/verify-code`

请求体：
```json
{
    "email": "user@example.com",
    "code": "123456"
}
```

响应：
```json
{
    "success": true,
    "message": "邮箱验证成功",
    "email": "user@example.com"
}
```

### 3. 邮箱注册

**POST** `/api/email/register`

请求体：
```json
{
    "username": "testuser",
    "password": "password123",
    "full_name": "测试用户",
    "role_key": "restorer",
    "email": "user@example.com",
    "phone": "13800138000",
    "unit": "测试单位",
    "code": "123456"
}
```

响应：
```json
{
    "user_id": 1,
    "username": "testuser",
    "full_name": "测试用户",
    "role_id": 2,
    "role_name": "修复专家",
    "role_key": "restorer",
    "email": "user@example.com",
    "phone": "13800138000",
    "unit": "测试单位",
    "is_active": true,
    "email_verified": true,
    "email_verified_at": "2025-01-09T10:00:00Z",
    "created_at": "2025-01-09T10:00:00Z"
}
```

### 4. 重新发送验证码

**POST** `/api/email/resend-verification`

请求体：
```json
{
    "email": "user@example.com"
}
```

### 5. 检查邮箱可用性

**GET** `/api/email/check-email/{email}`

响应：
```json
{
    "email": "user@example.com",
    "available": true,
    "message": "邮箱可用"
}
```

## 数据库变更

### 用户表新增字段

```sql
ALTER TABLE users ADD COLUMN email_verified BOOLEAN DEFAULT FALSE;
ALTER TABLE users ADD COLUMN email_verified_at TIMESTAMP WITH TIME ZONE;
```

## 依赖要求

确保已安装以下Python包：

```bash
pip install redis
pip install email-validator
```

## 注意事项

1. 确保Redis服务正在运行
2. 确保邮箱服务商的SMTP服务已开启
3. 使用正确的邮箱授权码，不是登录密码
4. 验证码存储在Redis中，确保Redis连接正常
5. 邮件发送失败时会自动清理验证码
6. 建议在生产环境中使用更安全的邮箱服务

## 故障排除

### 1. 邮件发送失败

- 检查SMTP配置是否正确
- 确认邮箱授权码是否正确
- 检查网络连接是否正常
- 查看服务器日志获取详细错误信息

### 2. 验证码验证失败

- 检查Redis服务是否运行
- 确认验证码是否过期
- 检查验证码格式是否正确

### 3. 数据库连接问题

- 确保PostgreSQL服务正在运行
- 检查数据库连接配置
- 确认数据库用户权限

## 作者信息

- **作者**: 王梓涵
- **邮箱**: wangzh011031@163.com
- **时间**: 2025年

