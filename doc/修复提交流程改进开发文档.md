# 修复提交流程改进开发文档

## 作者信息
- **作者**: 王梓涵
- **邮箱**: wangzh011031@163.com
- **项目**: 克孜尔石窟壁画智慧修复全生命周期管理系统
- **日期**: 2025年

## 1. 需求分析

### 1.1 现状分析
当前修复提交功能存在以下问题：
- 所有步骤都在弹窗（模态框）中完成，用户体验不够友好
- 无法在步骤间灵活跳转和返回
- 表单数据在页面切换时无法保留
- 缺少图片编辑功能

### 1.2 改进目标
将修复提交流程改为多页面流程，提升用户体验：
```
保密协议 ---o--- 提交修复表单 ---o--- 图片编辑修改 ---o--- 确认信息与提交 ---o--- 修复提交成功
|                                                                                                    |
|                    页面区域，可以跳转页面，也可以返回上一页，保留表单信息                                    |
```

## 2. 技术方案

### 2.1 技术栈
- **前端框架**: Vue 3 + TDesign
- **图片编辑**: vue-fabric-wrapper (已安装)
- **状态管理**: Pinia (全局表单状态管理)
- **路由管理**: Vue Router (页面跳转)

### 2.2 页面设计
创建以下新页面：
1. **保密协议页面** (`RestorationPrivacy.vue`)
2. **修复表单页面** (`RestorationForm.vue`) 
3. **图片编辑页面** (`RestorationImageEdit.vue`)
4. **信息确认页面** (`RestorationConfirm.vue`)
5. **提交成功页面** (`RestorationSuccess.vue`)

### 2.3 路由设计
```
/restoration-flow/:workflowId
├── /privacy (保密协议)
├── /form (表单填写)
├── /image-edit (图片编辑)
├── /confirm (信息确认)
└── /success (提交成功)
```

### 2.4 状态管理
使用 Pinia 创建 `useRestorationFlowStore`：
- 保存当前工作流ID
- 保存表单数据
- 保存当前步骤
- 提供数据持久化

## 3. 功能特性

### 3.1 核心功能
1. **步骤导航**
   - 显示当前进度
   - 支持前进/后退
   - 步骤状态提示

2. **表单保存**
   - 自动保存表单数据
   - 页面切换时保持数据
   - 离开提示功能

3. **图片编辑**
   - 使用 vue-fabric-wrapper 实现
   - 支持标注、文字、绘制
   - 编辑结果保存

4. **信息确认**
   - 完整表单信息预览
   - 图片编辑结果确认
   - 最终提交前确认

### 3.2 用户体验优化
- 响应式设计，移动端友好
- 加载状态提示
- 错误处理和重试
- 操作反馈

## 4. 页面结构设计

### 4.1 通用布局组件 (`RestorationFlowLayout.vue`)
```vue
<template>
  <Layout>
    <div class="restoration-flow">
      <!-- 进度条 -->
      <div class="flow-progress">
        <t-steps :current="currentStep" :options="stepOptions" />
      </div>
      
      <!-- 页面内容 -->
      <div class="flow-content">
        <router-view />
      </div>
      
      <!-- 导航按钮 -->
      <div class="flow-actions">
        <t-button @click="goBack" :disabled="!canGoBack">返回上一步</t-button>
        <t-button theme="primary" @click="goNext" :disabled="!canGoNext">
          {{ nextButtonText }}
        </t-button>
      </div>
    </div>
  </Layout>
</template>
```

### 4.2 各步骤页面结构
每个步骤页面都继承相同的布局和导航逻辑：

1. **保密协议页面**：显示协议内容，滚动检测
2. **表单页面**：原有表单内容，实时保存
3. **图片编辑页面**：fabric.js 画布，编辑工具
4. **确认页面**：信息汇总，最终确认
5. **成功页面**：成功提示，返回列表

### 4.3 状态管理结构
```javascript
// stores/restorationFlow.js
export const useRestorationFlowStore = defineStore('restorationFlow', {
  state: () => ({
    workflowId: null,
    currentStep: 0,
    formData: {
      image_file: null,
      image_desc: '',
      restoration_opinion: '',
      opinion_tags: '',
      remark: '',
      // ...其他字段
    },
    privacyAccepted: false,
    imageEditData: null,
    isSubmitting: false
  }),
  
  actions: {
    initFlow(workflowId) {},
    updateFormData(data) {},
    saveImageEdit(data) {},
    nextStep() {},
    prevStep() {},
    submitFlow() {},
    clearFlow() {}
  }
})
```

## 5. 开发步骤

### 阶段一：基础架构
1. 创建 Pinia store
2. 创建布局组件
3. 配置新路由

### 阶段二：页面开发
1. 保密协议页面
2. 表单填写页面
3. 图片编辑页面
4. 确认提交页面
5. 成功页面

### 阶段三：集成测试
1. 状态管理测试
2. 页面跳转测试
3. 数据保存测试
4. API 对接测试

### 阶段四：优化完善
1. 用户体验优化
2. 错误处理完善
3. 响应式适配
4. 性能优化

## 6. 注意事项

### 6.1 数据持久化
- 使用 localStorage 保存流程状态
- 页面刷新时恢复数据
- 流程完成后清理数据

### 6.2 路由守卫
- 检查流程状态
- 防止非法跳转
- 保护未完成的表单

### 6.3 离开页面提示
```javascript
// 在组件中监听页面离开
window.addEventListener('beforeunload', (e) => {
  if (hasUnsavedChanges.value) {
    e.preventDefault()
    e.returnValue = '您有未保存的修复表单，确定要离开吗？'
  }
})
```

### 6.4 移动端适配
- 响应式布局
- 触摸友好的操作
- 合适的字体大小

### 6.5 布局优化（2025年更新）

#### 6.5.1 工作流详情对话框优化
- **固定宽高设计**: 使用 `90vw` 和 `85vh` 替代固定像素值，确保在不同屏幕尺寸下都能完整显示
- **最大尺寸限制**: 设置 `maxWidth: '1400px'` 和 `maxHeight: '900px'` 避免在大屏幕上过度拉伸
- **内容区域优化**: 使用 `calc(85vh - 120px)` 计算对话框主体高度，为头部和边距预留空间

#### 6.5.2 修复表单历史滚动优化
- **独立滚动区域**: forms-list 设置为独立的滚动容器，高度自适应
- **form-item 单位滚动**: 每个表单项作为独立单元，支持 `scroll-margin-top` 精确定位
- **视觉优化**: 添加悬停效果和边框样式，提升用户体验
- **滚动条美化**: 自定义滚动条样式，宽度6px，圆角设计

#### 6.5.3 评估历史滚动优化
- **弹性布局**: 评估列表使用 flex 布局，自动分配空间
- **evaluation 单位滚动**: 每个评估项独立显示，支持精确滚动定位
- **操作区域固定**: 评估操作按钮固定在底部，不随内容滚动
- **响应式高度**: 根据容器高度自动调整评估列表高度

#### 6.5.4 RestorationFlowLayout 响应式优化
- **视口高度适配**: 使用 `calc(100vh - 120px)` 确保页面完整显示在视口内
- **溢出控制**: 设置 `overflow: hidden` 避免意外的滚动条
- **弹性布局**: 使用 flexbox 确保各区域合理分配空间
- **紧凑间距**: 减少不必要的边距，提高空间利用率

#### 6.5.5 确认页面布局优化
- **高度约束**: 设置页面高度为 `calc(100vh - 200px)`，避免纵向滚动
- **内容优先级**: 重要信息区域设置 `flex-shrink: 0` 确保完整显示
- **提交区域固定**: 提交按钮区域使用 `margin-top: auto` 固定在底部

#### 6.5.6 技术实现要点
```css
/* 关键CSS实现 */
.workflow-details-dialog :deep(.t-dialog__body) {
  height: calc(85vh - 120px);
  overflow: hidden;
}

.forms-list, .evaluations-list {
  height: 100%;
  overflow-y: auto;
  scroll-behavior: smooth;
}

.form-item, .evaluation-item {
  scroll-margin-top: 16px;
  transition: all 0.2s ease;
}
```

## 7. API 对接

保持现有 API 接口不变：
- `getPrivacyAgreement()` - 获取保密协议
- `submitForm(formData)` - 提交表单
- 其他现有接口

## 8. 测试计划

### 8.1 功能测试
- [ ] 流程完整性测试
- [ ] 表单数据保存测试  
- [ ] 图片编辑功能测试
- [ ] API 对接测试

### 8.2 用户体验测试
- [ ] 页面跳转流畅性
- [ ] 表单填写体验
- [ ] 移动端适配
- [ ] 错误处理

## 9. 部署说明

### 9.1 依赖检查
确认已安装必要依赖：
- vue-fabric-wrapper ✓
- pinia ✓
- tdesign-vue-next ✓

### 9.2 构建配置
无需额外配置，使用现有 Vite 构建配置。

---

**开发准则**: 保持代码简洁、注释清晰，遵循现有项目规范，确保功能稳定可用。
