# 知识体系文件存储功能完成说明

**作者**: 王梓涵  
**邮箱**: wangzh011031@163.com  
**时间**: 2025年

## 功能概述

已成功实现克孜尔石窟壁画智慧修复全生命周期管理系统的知识体系文件存储功能，包括完整的后端API接口、数据库表结构和MinIO存储桶配置。

## 已完成的功能

### 1. 数据库表结构 ✅

创建了 `knowledge_system_files` 表，包含以下字段：

- `id`: 主键ID（自增）
- `unit`: 单位或提供人（VARCHAR(100)）
- `filename`: 文件名（VARCHAR(255)）
- `file_url`: 文件链接（TEXT，MinIO存储桶）
- `file_type`: 文件类型（VARCHAR(20)）
- `submission_info`: 提交信息（VARCHAR(100)）
- `status`: 状态（VARCHAR(20)，默认'active'）
- `remark`: 备注（TEXT）
- `created_at`: 创建时间（TIMESTAMP）
- `updated_at`: 更新时间（TIMESTAMP）
- `deleted_at`: 删除时间（TIMESTAMP，软删除）

### 2. 数据模型 ✅

在 `app/models/models.py` 中添加了 `KnowledgeSystemFile` 模型类。

### 3. 数据验证模式 ✅

在 `app/schemas/schemas.py` 中添加了以下Pydantic模型：

- `KnowledgeSystemFileCreate`: 创建文件记录的数据模式
- `KnowledgeSystemFileUpdate`: 更新文件记录的数据模式
- `KnowledgeSystemFileResponse`: 文件记录响应数据模式
- `KnowledgeSystemFilePaginatedResponse`: 分页响应数据模式

### 4. API接口 ✅

在 `app/api/routes.py` 中添加了完整的RESTful API接口：

#### 文件记录管理
- `POST /api/knowledge-files` - 创建文件记录
- `GET /api/knowledge-files` - 获取文件列表（支持分页和筛选）
- `GET /api/knowledge-files/{file_id}` - 获取单个文件详情
- `PUT /api/knowledge-files/{file_id}` - 更新文件记录
- `DELETE /api/knowledge-files/{file_id}` - 软删除文件记录
- `POST /api/knowledge-files/batch-delete` - 批量删除文件记录

#### 文件上传
- `POST /api/knowledge-files/upload` - 上传文件到MinIO存储桶

#### 统计信息
- `GET /api/knowledge-files/stats` - 获取文件统计信息

### 5. 文件存储服务 ✅

在 `app/services/file_service.py` 中扩展了MinIO文件服务：

- 添加了 `knowledge-files` 存储桶支持
- 实现了异步文件上传方法 `upload_file_async`
- 自动创建存储桶功能

### 6. 数据库初始化脚本 ✅

更新了 `database_schema.sql`：

- 添加了 `knowledge_system_files` 表创建语句
- 添加了相关索引创建语句
- 优化了查询性能

### 7. 数据库迁移脚本 ✅

创建了 `migrate_knowledge_system.py` 和 `migrate_knowledge_simple.py`：

- 自动创建数据库表
- 自动创建索引
- 自动创建MinIO存储桶

## 支持的文件类型

- **文档类**: doc, docx, pdf, txt
- **图片类**: jpg, png, tif
- **表格类**: xlsx
- **学术类**: caj
- **演示类**: ppt, pptx
- **压缩类**: zip, rar

## 支持的提交信息类型

- 论文
- 洞窟照片
- 建模文件
- 海外残片
- 绘画手稿
- 研究报告
- 技术文档
- 其他

## 功能特性

### 1. 完整的CRUD操作
- 创建、读取、更新、删除文件记录
- 支持批量操作
- 软删除机制

### 2. 高级查询功能
- 分页查询
- 多条件筛选（单位、文件类型、提交信息、状态）
- 关键词搜索（文件名、单位、备注）
- 排序功能

### 3. 文件上传管理
- 支持多种文件类型
- 自动生成唯一文件名
- 按日期组织目录结构
- 文件类型验证

### 4. 统计功能
- 总文件数统计
- 按文件类型分布统计
- 按提交信息分布统计
- 按单位分布统计

### 5. 权限控制
- 需要用户登录
- 需要修复专家或以上权限

## 数据库索引

为提高查询性能，创建了以下索引：

- `idx_knowledge_files_unit` - 单位字段索引
- `idx_knowledge_files_file_type` - 文件类型字段索引
- `idx_knowledge_files_submission_info` - 提交信息字段索引
- `idx_knowledge_files_status` - 状态字段索引
- `idx_knowledge_files_created_at` - 创建时间字段索引
- `idx_knowledge_files_deleted_at` - 删除时间字段索引

## MinIO存储桶

- 存储桶名称: `knowledge-files`
- 文件组织方式: `YYYY/MM/DD/uuid_timestamp.ext`
- 支持的文件类型: 所有支持的文件类型
- 自动创建存储桶功能

## 部署说明

### 1. 数据库迁移

运行以下命令创建数据库表：

```bash
# 使用简化版迁移脚本（推荐）
python migrate_knowledge_simple.py

# 或使用完整版迁移脚本
python migrate_knowledge_system.py
```

### 2. 手动SQL执行

如果迁移脚本无法运行，可以手动执行以下SQL：

```sql
-- 创建表
CREATE TABLE IF NOT EXISTS knowledge_system_files (
    id SERIAL PRIMARY KEY,
    unit VARCHAR(100) NOT NULL,
    filename VARCHAR(255) NOT NULL,
    file_url TEXT NOT NULL,
    file_type VARCHAR(20) NOT NULL,
    submission_info VARCHAR(100) NOT NULL,
    status VARCHAR(20) DEFAULT 'active',
    remark TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    deleted_at TIMESTAMP WITH TIME ZONE
);

-- 创建索引
CREATE INDEX IF NOT EXISTS idx_knowledge_files_unit ON knowledge_system_files(unit);
CREATE INDEX IF NOT EXISTS idx_knowledge_files_file_type ON knowledge_system_files(file_type);
CREATE INDEX IF NOT EXISTS idx_knowledge_files_submission_info ON knowledge_system_files(submission_info);
CREATE INDEX IF NOT EXISTS idx_knowledge_files_status ON knowledge_system_files(status);
CREATE INDEX IF NOT EXISTS idx_knowledge_files_created_at ON knowledge_system_files(created_at);
CREATE INDEX IF NOT EXISTS idx_knowledge_files_deleted_at ON knowledge_system_files(deleted_at);
```

### 3. MinIO存储桶

确保MinIO服务运行，存储桶 `knowledge-files` 会在首次上传文件时自动创建。

## API文档

详细的API使用说明请参考：`doc/知识体系文件存储API文档.md`

## 测试建议

1. **功能测试**
   - 测试所有API接口的CRUD操作
   - 测试文件上传功能
   - 测试分页和筛选功能
   - 测试批量操作功能

2. **性能测试**
   - 测试大量数据的分页查询性能
   - 测试文件上传性能
   - 测试统计查询性能

3. **安全测试**
   - 测试权限控制
   - 测试文件类型验证
   - 测试输入验证

## 注意事项

1. 所有文件上传到MinIO的 `knowledge-files` 存储桶
2. 文件按日期组织目录结构：`YYYY/MM/DD/`
3. 文件名会自动添加UUID和时间戳以确保唯一性
4. 支持软删除，删除的记录不会物理删除
5. 所有时间字段使用UTC时区
6. 文件类型和提交信息有严格的验证规则

## 后续扩展建议

1. **文件预览功能**
   - 支持PDF、图片等文件的在线预览
   - 集成文档预览服务

2. **文件版本管理**
   - 支持文件版本控制
   - 文件更新历史记录

3. **文件分类标签**
   - 支持多标签分类
   - 标签筛选功能

4. **文件分享功能**
   - 生成文件分享链接
   - 设置分享权限和有效期

5. **文件审批流程**
   - 文件上传审批
   - 文件发布审核

## 总结

知识体系文件存储功能已完全实现，包括：

✅ 数据库表结构和索引  
✅ 数据模型和验证  
✅ 完整的RESTful API接口  
✅ MinIO文件存储集成  
✅ 分页查询和筛选功能  
✅ 文件上传和管理功能  
✅ 统计和分析功能  
✅ 权限控制和安全验证  
✅ 完整的API文档  

该功能为克孜尔石窟壁画智慧修复全生命周期管理系统提供了强大的文件管理能力，支持多种文件类型的存储、检索和管理，满足系统的知识体系文件存储需求。
