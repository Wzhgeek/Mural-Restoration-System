# 数据库迁移脚本整理说明

**作者**: 王梓涵  
**邮箱**: wangzh011031@163.com  
**时间**: 2025年

## 整理概述

本次整理将所有分散的数据库迁移脚本整合到 `init_database.py` 中，实现了一个脚本完成所有数据库表格构建的目标。

## 整合的迁移脚本

### 1. migrate_database.py
**功能**: 基础字段迁移
- 添加用户表 `unit` 字段（用户单位）
- 添加评估表 `personnel_confirmation` 字段（人员确认）
- 更新测试用户数据

### 2. migrate_email_verification.py
**功能**: 邮件验证功能
- 添加 `email_verified` 字段（布尔值）
- 添加 `email_verified_at` 字段（时间戳）

### 3. migrate_knowledge_simple.py
**功能**: 知识体系文件存储（简化版）
- 创建 `knowledge_system_files` 表
- 创建相关索引
- 初始化MinIO存储桶

### 4. migrate_knowledge_system.py
**功能**: 知识体系文件存储（完整版）
- 创建 `knowledge_system_files` 表（更详细的字段定义）
- 创建相关索引
- 检查MinIO存储桶

### 5. migrate_multifile_support.py
**功能**: 多文件上传支持
- 为 `forms` 表添加多个JSONB字段
- 为 `evaluations` 表添加文件字段
- 为 `rollback_requests` 表添加文件字段

### 6. migrate_workflow_user_fields.py
**功能**: 工作流表字段
- 添加 `user_id` 和 `username` 字段到 `workflows` 表
- 从 `initiator_id` 关联获取用户名数据
- 创建相关索引

## 整合后的功能

### 新的 init_database.py 功能

1. **数据库创建**: 自动创建PostgreSQL数据库（如果不存在）
2. **表结构创建**: 创建所有基础数据表
3. **迁移应用**: 应用所有数据库迁移（整合了6个迁移脚本的功能）
4. **基础数据初始化**: 初始化角色、用户、系统配置等
5. **测试数据更新**: 更新用户单位、工作流用户信息等
6. **MinIO存储桶初始化**: 创建主存储桶和知识体系文件存储桶

### 迁移功能详情

#### 迁移1: 用户单位和人员确认字段
- `users.unit` - 用户单位字段
- `evaluations.personnel_confirmation` - 人员确认字段

#### 迁移2: 邮件验证字段
- `users.email_verified` - 邮件验证状态
- `users.email_verified_at` - 邮件验证时间

#### 迁移3: 知识体系文件存储表
- `knowledge_system_files` - 完整的文件管理表
- 支持多种文件类型和提交信息
- 完整的索引优化

#### 迁移4: 多文件上传支持
- `forms.image_urls` - 图片URL数组
- `forms.image_metas` - 图片元数据
- `forms.image_desc_files` - 图片描述文件
- `forms.opinion_files` - 意见文件
- `forms.attachments` - 附件
- `evaluations.evaluation_files` - 评估文件
- `rollback_requests.support_file_urls` - 支持文件URL

#### 迁移5: 工作流表用户字段
- `workflows.user_id` - 用户ID（关联users表）
- `workflows.username` - 用户名

## 使用方法

### 执行完整初始化
```bash
python init_database.py
```

### 功能特性
- **事务安全**: 所有迁移操作都在事务中执行，失败时自动回滚
- **幂等性**: 可以重复执行，不会重复创建已存在的字段或表
- **错误处理**: 完整的错误处理和状态显示
- **进度显示**: 详细的执行步骤和状态信息

## 清理说明

以下迁移脚本已被删除，功能已整合到 `init_database.py` 中：
- `migrate_database.py`
- `migrate_email_verification.py`
- `migrate_knowledge_simple.py`
- `migrate_knowledge_system.py`
- `migrate_multifile_support.py`
- `migrate_workflow_user_fields.py`

## 优势

1. **统一管理**: 所有数据库初始化操作集中在一个脚本中
2. **简化部署**: 只需执行一个脚本即可完成所有数据库设置
3. **事务安全**: 确保数据一致性
4. **易于维护**: 减少了文件数量，便于管理和维护
5. **完整日志**: 详细的执行日志和状态信息

## 注意事项

1. 确保PostgreSQL服务正在运行
2. 确保MinIO服务正在运行（可选）
3. 确保已安装所有项目依赖
4. 脚本会自动检查字段是否已存在，可以安全地重复执行

## 后续维护

如果需要添加新的数据库迁移，请直接在 `init_database.py` 的 `apply_database_migrations()` 函数中添加相应的迁移逻辑，而不是创建新的迁移脚本文件。
