# 数据库字段更新说明

**作者**: 王梓涵  
**邮箱**: wangzh011031@163.com  
**时间**: 2025年

## 更新概述

本次更新为克孜尔石窟壁画智慧修复全生命周期管理系统添加了两个重要字段：

1. **用户表单位字段** - 用于记录用户所属单位
2. **评估表人员确认字段** - 用于记录评估人员确认信息（用户名+单位）

## 具体更新内容

### 1. 用户表 (users) 更新

**新增字段**:
- `unit` VARCHAR(100) - 用户单位字段，可为空

**字段说明**:
- 用于记录用户所属的单位或机构
- 支持中文单位名称
- 最大长度100个字符
- 可为空，兼容现有数据

### 2. 评估表 (evaluations) 更新

**新增字段**:
- `personnel_confirmation` VARCHAR(200) - 人员确认字段，可为空

**字段说明**:
- 用于记录评估人员的确认信息
- 格式：用户名+单位（如：张三-克孜尔石窟研究院）
- 最大长度200个字符
- 可为空，兼容现有数据

## 数据库Schema更新

### 用户表结构
```sql
CREATE TABLE IF NOT EXISTS users (
    user_id SERIAL PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    full_name VARCHAR(100) NOT NULL,
    role_id INTEGER NOT NULL REFERENCES roles(role_id),
    email VARCHAR(100) UNIQUE,
    phone VARCHAR(20),
    unit VARCHAR(100),  -- 新增：用户单位字段
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    deleted_at TIMESTAMP WITH TIME ZONE
);
```

### 评估表结构
```sql
CREATE TABLE IF NOT EXISTS evaluations (
    evaluate_id SERIAL PRIMARY KEY,
    workflow_id UUID NOT NULL REFERENCES workflows(workflow_id),
    evaluator_id INTEGER NOT NULL REFERENCES users(user_id),
    score SMALLINT CHECK (score >= 0 AND score <= 100),
    comment TEXT,
    evaluation_file TEXT,
    personnel_confirmation VARCHAR(200),  -- 新增：人员确认字段
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

## 模型更新

### SQLAlchemy模型更新

**User模型**:
```python
class User(Base):
    # ... 其他字段 ...
    unit = Column(String(100))  # 用户单位字段
    # ... 其他字段 ...
```

**Evaluation模型**:
```python
class Evaluation(Base):
    # ... 其他字段 ...
    personnel_confirmation = Column(String(200))  # 人员确认字段
    # ... 其他字段 ...
```

### Pydantic Schema更新

**UserCreate**:
```python
class UserCreate(BaseModel):
    # ... 其他字段 ...
    unit: Optional[str] = None  # 用户单位字段
```

**UserResponse**:
```python
class UserResponse(BaseModel):
    # ... 其他字段 ...
    unit: Optional[str]  # 用户单位字段
```

**EvaluationCreate**:
```python
class EvaluationCreate(BaseModel):
    # ... 其他字段 ...
    personnel_confirmation: Optional[str] = None  # 人员确认字段
```

**EvaluationResponse**:
```python
class EvaluationResponse(BaseModel):
    # ... 其他字段 ...
    personnel_confirmation: Optional[str]  # 人员确认字段
```

## 测试数据更新

更新了测试用户数据，添加了单位信息：

- **restorer1** (修复专家张三) - 单位：克孜尔石窟研究院
- **evaluator1** (评估专家李四) - 单位：文物保护中心

## 迁移脚本

提供了 `migrate_database.py` 脚本用于更新现有数据库：

```bash
python migrate_database.py
```

**迁移脚本功能**:
1. 检查并添加用户表unit字段
2. 检查并添加评估表personnel_confirmation字段
3. 更新现有测试用户数据，添加单位信息
4. 提供详细的执行日志和错误处理

## 兼容性说明

- **向后兼容**: 新增字段均为可选字段，不影响现有功能
- **数据安全**: 迁移过程中不会删除或修改现有数据
- **渐进式更新**: 可以逐步更新现有用户和评估记录

## 使用建议

1. **用户注册时**: 建议填写单位信息，便于后续管理
2. **评估提交时**: 系统可自动生成人员确认信息（用户名+单位）
3. **数据查询时**: 可通过单位字段进行用户分类和统计

## 注意事项

1. 运行迁移脚本前请备份数据库
2. 确保数据库连接配置正确
3. 迁移过程中请勿中断操作
4. 建议在测试环境先验证迁移脚本

## 后续开发

这些新字段为以下功能提供了数据基础：

1. **用户管理**: 按单位分类管理用户
2. **评估追踪**: 记录评估人员的确认信息
3. **统计分析**: 按单位统计工作量和质量
4. **权限控制**: 基于单位的访问控制
5. **审计日志**: 更详细的用户行为追踪

---

**更新完成时间**: 2025年  
**版本**: v1.1.0  
**影响范围**: 数据库结构、API接口、前端显示
