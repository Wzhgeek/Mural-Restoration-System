# 克孜尔石窟壁画智慧修复全生命周期管理系统 - 前端对接文档

## 1. 接口概述

### 1.1 基础信息
- **基础URL**: `http://localhost:8080`
- **API前缀**: `/api`
- **认证方式**: JWT Bearer Token
- **响应格式**: JSON
- **字符编码**: UTF-8

### 1.2 通用请求头
```http
Authorization: Bearer <token>
Content-Type: application/json
```

### 1.3 通用响应格式

#### 成功响应
```json
{
    "success": true,
    "message": "操作成功",
    "data": {
        // 具体数据
    }
}
```

#### 错误响应
```json
{
    "detail": "错误信息"
}
```

### 1.4 HTTP状态码说明
| 状态码 | 说明 |
|--------|------|
| 200 | 请求成功 |
| 201 | 创建成功 |
| 400 | 请求参数错误 |
| 401 | 未认证/认证失败 |
| 403 | 无权限访问 |
| 404 | 资源不存在 |
| 413 | 文件大小超过限制 |
| 500 | 服务器内部错误 |

## 2. 认证接口

### 2.1 用户登录
**接口**: `POST /api/login`  
**权限**: 无需认证  
**描述**: 用户登录获取访问令牌

#### 请求参数
```json
{
    "username": "string",  // 用户名
    "password": "string"   // 密码
}
```

#### 响应示例
```json
{
    "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "token_type": "bearer",
    "user": {
        "user_id": 1,
        "username": "admin",
        "full_name": "系统管理员",
        "role_name": "管理员",
        "role_key": "admin",
        "email": "admin@repair.com",
        "phone": null,
        "is_active": true,
        "created_at": "2024-01-01T00:00:00"
    }
}
```

### 2.2 获取当前用户信息
**接口**: `GET /api/user/me`  
**权限**: 需要认证  
**描述**: 获取当前登录用户的详细信息

#### 响应示例
```json
{
    "user_id": 1,
    "username": "admin",
    "full_name": "系统管理员",
    "role_name": "管理员",
    "role_key": "admin",
    "email": "admin@repair.com",
    "phone": null,
    "is_active": true,
    "created_at": "2024-01-01T00:00:00"
}
```

### 2.3 更新个人信息
**接口**: `PUT /api/user/profile`  
**权限**: 需要认证  
**描述**: 更新用户个人信息

#### 请求参数
```json
{
    "full_name": "string",     // 姓名（必填）
    "email": "string",          // 邮箱（可选）
    "phone": "string"           // 电话（可选）
}
```

### 2.4 修改密码
**接口**: `PUT /api/user/password`  
**权限**: 需要认证  
**描述**: 修改用户密码

#### 请求参数
```json
{
    "current_password": "string",  // 当前密码
    "new_password": "string"        // 新密码
}
```

## 3. 工作流管理接口

### 3.1 创建工作流
**接口**: `POST /api/workflows`  
**权限**: 修复专家  
**描述**: 创建新的修复工作流

#### 请求参数
```json
{
    "title": "string",          // 工作流标题（必填）
    "description": "string"     // 工作流描述（可选）
}
```

#### 响应示例
```json
{
    "workflow_id": "550e8400-e29b-41d4-a716-446655440000",
    "title": "克孜尔石窟第38窟壁画修复",
    "description": "主室东壁壁画修复工作",
    "initiator_name": "修复专家张三",
    "current_step": 1,
    "status": "draft",
    "is_finalized": false,
    "created_at": "2024-01-01T10:00:00",
    "updated_at": "2024-01-01T10:00:00"
}
```

### 3.2 获取工作流列表
**接口**: `GET /api/workflows`  
**权限**: 需要认证  
**描述**: 获取工作流列表（修复专家只能看到自己的，管理员和评估专家可以看到所有）

#### 查询参数
- `status`: 工作流状态筛选（可选）
  - `draft`: 草稿
  - `running`: 运行中
  - `finished`: 已完成
  - `paused`: 已暂停
  - `revoked`: 已撤销

#### 响应示例
```json
[
    {
        "workflow_id": "550e8400-e29b-41d4-a716-446655440000",
        "title": "克孜尔石窟第38窟壁画修复",
        "description": "主室东壁壁画修复工作",
        "initiator_name": "修复专家张三",
        "current_step": 3,
        "status": "running",
        "is_finalized": false,
        "created_at": "2024-01-01T10:00:00",
        "updated_at": "2024-01-02T15:30:00"
    }
]
```

### 3.3 设置最终方案
**接口**: `POST /api/workflows/{workflow_id}/finalize`  
**权限**: 修复专家（仅工作流发起人）  
**描述**: 将某个表单设置为工作流的最终方案

#### 请求参数（Form-Data）
- `final_form_id`: UUID格式的表单ID

#### 响应示例
```json
{
    "success": true,
    "message": "工作流已设置为最终方案",
    "data": {
        "workflow_id": "550e8400-e29b-41d4-a716-446655440000",
        "final_form_id": "660e8400-e29b-41d4-a716-446655440001"
    }
}
```

## 4. 修复表单接口

### 4.1 创建修复表单
**接口**: `POST /api/forms`  
**权限**: 修复专家  
**描述**: 为工作流创建新的修复表单（支持多步骤）

#### 请求参数（Form-Data）
```
workflow_id: UUID                    // 工作流ID（必填）
image_desc: string                   // 图片描述（可选）
restoration_opinion: string          // 修复意见（可选）
opinion_tags: string                  // 意见标签，JSON数组格式（可选）
remark: string                        // 备注（可选）
image_file: file                     // 图片文件（可选）
image_desc_file: file                // 图片描述文件（可选）
opinion_file: file                   // 意见文件（可选）
attachment_file: file                // 附件（可选）
```

#### 响应示例
```json
{
    "form_id": "770e8400-e29b-41d4-a716-446655440002",
    "workflow_id": "550e8400-e29b-41d4-a716-446655440000",
    "step_no": 1,
    "submitter_name": "修复专家张三",
    "image_url": "http://localhost:9000/repair-file/image1.jpg",
    "image_meta": {
        "filename": "damage_area.jpg",
        "size": 2048576,
        "content_type": "image/jpeg"
    },
    "image_desc": "东壁中部区域脱落情况",
    "image_desc_file": null,
    "restoration_opinion": "建议采用传统工艺进行修复",
    "opinion_tags": ["传统工艺", "局部修复"],
    "opinion_file": null,
    "remark": "需要特别注意颜料配比",
    "attachment": null,
    "created_at": "2024-01-02T10:00:00"
}
```

### 4.2 获取工作流的所有表单
**接口**: `GET /api/workflows/{workflow_id}/forms`  
**权限**: 需要认证  
**描述**: 获取指定工作流的所有修复表单

#### 响应示例
```json
[
    {
        "form_id": "770e8400-e29b-41d4-a716-446655440002",
        "workflow_id": "550e8400-e29b-41d4-a716-446655440000",
        "step_no": 1,
        "submitter_name": "修复专家张三",
        "image_url": "http://localhost:9000/repair-file/image1.jpg",
        "image_meta": {
            "filename": "damage_area.jpg",
            "size": 2048576,
            "content_type": "image/jpeg"
        },
        "image_desc": "东壁中部区域脱落情况",
        "restoration_opinion": "建议采用传统工艺进行修复",
        "opinion_tags": ["传统工艺", "局部修复"],
        "created_at": "2024-01-02T10:00:00"
    },
    {
        "form_id": "880e8400-e29b-41d4-a716-446655440003",
        "workflow_id": "550e8400-e29b-41d4-a716-446655440000",
        "step_no": 2,
        "submitter_name": "修复专家张三",
        "image_url": "http://localhost:9000/repair-file/image2.jpg",
        "restoration_opinion": "第一步修复完成，进行第二阶段",
        "created_at": "2024-01-03T14:00:00"
    }
]
```

## 5. 评估接口

### 5.1 创建评估
**接口**: `POST /api/evaluations`  
**权限**: 评估专家  
**描述**: 对已完成的工作流进行评估

#### 请求参数（Form-Data）
```
workflow_id: string                  // 工作流ID（必填）
score: integer                       // 评分0-100（必填）
comment: string                      // 评价意见（可选）
support_file: file                   // 支撑文件（可选）
```

#### 响应示例
```json
{
    "evaluate_id": 1,
    "workflow_id": "550e8400-e29b-41d4-a716-446655440000",
    "evaluator_name": "评估专家李四",
    "score": 85,
    "comment": "修复方案合理，执行到位，效果良好",
    "evaluation_file": "http://localhost:9000/repair-file/eval1.pdf",
    "created_at": "2024-01-05T10:00:00",
    "updated_at": "2024-01-05T10:00:00"
}
```

### 5.2 获取工作流的评估列表
**接口**: `GET /api/workflows/{workflow_id}/evaluations`  
**权限**: 需要认证  
**描述**: 获取指定工作流的所有评估记录

#### 响应示例
```json
[
    {
        "evaluate_id": 1,
        "workflow_id": "550e8400-e29b-41d4-a716-446655440000",
        "evaluator_name": "评估专家李四",
        "score": 85,
        "comment": "修复方案合理，执行到位",
        "evaluation_file": null,
        "created_at": "2024-01-05T10:00:00",
        "updated_at": "2024-01-05T10:00:00"
    },
    {
        "evaluate_id": 2,
        "workflow_id": "550e8400-e29b-41d4-a716-446655440000",
        "evaluator_name": "评估专家王五",
        "score": 90,
        "comment": "优秀的修复工作",
        "evaluation_file": "http://localhost:9000/repair-file/eval2.pdf",
        "created_at": "2024-01-05T14:00:00",
        "updated_at": "2024-01-05T14:00:00"
    }
]
```

### 5.3 获取用户的评估历史
**接口**: `GET /api/evaluations`  
**权限**: 需要认证  
**描述**: 获取当前用户的评估历史（评估专家看自己的，管理员看所有的）

## 6. 回溯申请接口

### 6.1 创建回溯申请
**接口**: `POST /api/rollback-requests`  
**权限**: 修复专家  
**描述**: 申请将工作流回溯到某个历史表单

#### 请求参数（Form-Data）
```
workflow_id: string                  // 工作流ID（必填）
target_form_id: string               // 目标表单ID（必填）
reason: string                       // 申请原因（必填）
support_file: file                   // 支撑文件（可选）
```

#### 响应示例
```json
{
    "rollback_id": 1,
    "workflow_id": "550e8400-e29b-41d4-a716-446655440000",
    "requester_name": "修复专家张三",
    "target_form_id": "770e8400-e29b-41d4-a716-446655440002",
    "reason": "发现更好的修复方案，需要回溯到第一步重新开始",
    "support_file_url": "http://localhost:9000/repair-file/rollback1.pdf",
    "status": "pending",
    "approver_name": null,
    "approved_at": null,
    "created_at": "2024-01-06T10:00:00"
}
```

### 6.2 审批回溯申请
**接口**: `POST /api/rollback-requests/{rollback_id}/approve`  
**权限**: 管理员  
**描述**: 审批回溯申请

#### 请求参数（Form-Data）
```
approve: boolean                     // true批准，false拒绝（必填）
```

#### 响应示例
```json
{
    "success": true,
    "message": "回溯申请已处理",
    "data": {
        "rollback_id": 1,
        "approved": true
    }
}
```

### 6.3 获取回溯申请列表
**接口**: `GET /api/rollback-requests`  
**权限**: 需要认证  
**描述**: 获取回溯申请列表

#### 查询参数
- `status`: 状态筛选（可选）
  - `pending`: 待审批
  - `approved`: 已批准
  - `rejected`: 已拒绝

#### 响应示例
```json
[
    {
        "rollback_id": 1,
        "workflow_id": "550e8400-e29b-41d4-a716-446655440000",
        "requester_name": "修复专家张三",
        "target_form_id": "770e8400-e29b-41d4-a716-446655440002",
        "reason": "发现更好的修复方案",
        "support_file_url": null,
        "status": "approved",
        "approver_name": "系统管理员",
        "approved_at": "2024-01-06T15:00:00",
        "created_at": "2024-01-06T10:00:00"
    }
]
```

## 7. 文件上传接口

### 7.1 通用文件上传
**接口**: `POST /api/upload`  
**权限**: 需要认证  
**描述**: 上传文件到MinIO存储

#### 请求参数（Form-Data）
```
file: file                           // 文件（必填）
```

#### 文件限制
- 最大文件大小：100MB
- 支持的图片格式：JPEG, PNG, BMP, TIFF
- 支持的文档格式：PDF, Word, TXT

#### 响应示例
```json
{
    "filename": "repair_plan.pdf",
    "file_url": "http://localhost:9000/repair-file/2024/01/repair_plan.pdf",
    "file_size": 1048576,
    "content_type": "application/pdf"
}
```

## 8. 仪表板接口

### 8.1 获取仪表板统计数据
**接口**: `GET /api/dashboard`  
**权限**: 需要认证  
**描述**: 获取仪表板统计数据（根据用户角色返回不同数据）

#### 响应示例（管理员）
```json
{
    "total_workflows": 150,
    "running_workflows": 25,
    "finished_workflows": 120,
    "pending_evaluations": 15,
    "pending_rollbacks": 3,
    "completion_rate": 80.0,
    "workflow_trend": 12.5,
    "workflow_trend_data": {
        "labels": ["周一", "周二", "周三", "周四", "周五", "周六", "周日"],
        "values": [5, 3, 7, 4, 6, 2, 4]
    },
    "score_distribution": {
        "0-6": 2,
        "6-7": 5,
        "7-8": 15,
        "8-9": 18,
        "9-10": 10
    },
    "recent_activities": [
        {
            "action": "submit",
            "operator": "修复专家张三",
            "time": "2024-01-06 15:30",
            "form_id": "770e8400-e29b-41d4-a716-446655440002",
            "workflow_title": "克孜尔石窟第38窟壁画修复",
            "comment": "提交第3步修复表单"
        }
    ]
}
```

#### 响应示例（修复专家）
```json
{
    "total_workflows": 150,
    "running_workflows": 25,
    "finished_workflows": 120,
    "my_workflows": 12,
    "my_running_workflows": 3,
    "my_finished_workflows": 9,
    "my_rollback_requests": 2,
    "monthly_submissions": 5,
    "average_score": 8.5,
    "completion_rate": 75.0,
    "personal_progress": {
        "monthly_completion": 80.0,
        "quality_score": 85.0
    },
    "recent_activities": [...]
}
```

#### 响应示例（评估专家）
```json
{
    "total_workflows": 150,
    "running_workflows": 25,
    "finished_workflows": 120,
    "pending_evaluations": 15,
    "completed_evaluations": 45,
    "monthly_evaluations": 12,
    "average_given_score": 8.2,
    "high_score_rate": 72.5,
    "evaluation_efficiency": 3.5,
    "score_distribution": {
        "0-6": 1,
        "6-7": 3,
        "7-8": 8,
        "8-9": 10,
        "9-10": 5
    },
    "recent_activities": [...]
}
```

## 9. 系统配置接口

### 9.1 获取保密协议
**接口**: `GET /api/privacy-agreement`  
**权限**: 无需认证  
**描述**: 获取系统保密协议内容

#### 响应示例
```json
{
    "success": true,
    "message": "获取成功",
    "data": {
        "content": "保密协议\n\n尊敬的用户：\n\n感谢您使用克孜尔石窟壁画智慧修复全生命周期管理系统..."
    }
}
```

## 10. 管理员专用接口

### 10.1 获取所有工作流
**接口**: `GET /api/admin/workflows`  
**权限**: 管理员  
**描述**: 管理员获取系统中所有工作流

### 10.2 更新工作流
**接口**: `PUT /api/admin/workflows/{workflow_id}`  
**权限**: 管理员  
**描述**: 管理员更新工作流信息

#### 请求参数
```json
{
    "title": "string",          // 标题（可选）
    "description": "string",    // 描述（可选）
    "status": "string"          // 状态（可选）
}
```

### 10.3 删除工作流
**接口**: `DELETE /api/admin/workflows/{workflow_id}`  
**权限**: 管理员  
**描述**: 管理员删除工作流（不能删除包含表单的工作流）

### 10.4 获取所有表单
**接口**: `GET /api/admin/forms`  
**权限**: 管理员  
**描述**: 管理员获取所有表单

#### 查询参数
- `workflow_id`: 按工作流ID筛选（可选）

### 10.5 更新表单
**接口**: `PUT /api/admin/forms/{form_id}`  
**权限**: 管理员  
**描述**: 管理员更新表单信息

### 10.6 删除表单
**接口**: `DELETE /api/admin/forms/{form_id}`  
**权限**: 管理员  
**描述**: 管理员删除表单（不能删除工作流的唯一表单）

## 11. 前端开发注意事项

### 11.1 认证处理
1. 登录成功后，将 `access_token` 保存到 localStorage 或 sessionStorage
2. 每次API请求时，在请求头中添加：`Authorization: Bearer <token>`
3. 收到401错误时，清除token并跳转到登录页
4. Token有效期为24小时，建议在过期前刷新或重新登录

### 11.2 文件上传
1. 使用 `multipart/form-data` 格式
2. 注意文件大小限制（100MB）
3. 上传前进行文件类型验证
4. 显示上传进度条提升用户体验
5. 处理上传失败的情况

### 11.3 错误处理
1. 统一处理HTTP错误状态码
2. 显示友好的错误提示信息
3. 记录错误日志便于调试
4. 提供重试机制

### 11.4 权限控制
1. 根据用户角色显示/隐藏功能模块
2. 前端权限控制仅用于UI展示，真正的权限验证在后端
3. 角色对应的功能权限：
   - **管理员**: 所有功能
   - **修复专家**: 工作流管理、表单提交、回溯申请
   - **评估专家**: 查看工作流、评估打分

### 11.5 数据缓存
1. 缓存用户信息避免重复请求
2. 缓存工作流列表，定时刷新
3. 使用乐观更新提升用户体验
4. 注意缓存失效策略

### 11.6 分页处理
虽然当前API未实现分页，建议前端准备分页组件，未来API升级时可快速对接：
```javascript
// 预留分页参数
const params = {
    page: 1,
    page_size: 20,
    // 其他筛选参数
};
```

### 11.7 日期时间处理
1. 后端返回的时间格式为ISO 8601格式
2. 使用moment.js或dayjs进行时间格式化
3. 注意时区处理
4. 显示相对时间（如"3小时前"）提升用户体验

### 11.8 表单验证
1. 前端进行基础验证（必填、格式等）
2. 提交前进行完整性检查
3. 显示实时验证反馈
4. 处理后端返回的验证错误

### 11.9 WebSocket支持（预留）
虽然当前未实现WebSocket，建议预留接口：
```javascript
// 预留WebSocket连接
const ws = new WebSocket('ws://localhost:8080/ws');
ws.onmessage = (event) => {
    // 处理实时消息
};
```

### 11.10 国际化支持
1. 准备中英文语言包
2. 日期、数字格式本地化
3. 错误信息多语言支持

## 12. 开发环境配置

### 12.1 开发服务器
```bash
# 后端服务
http://localhost:8080

# API文档
http://localhost:8080/docs

# MinIO控制台
http://localhost:9000
```

### 12.2 测试账号
| 角色 | 用户名 | 密码 |
|------|--------|------|
| 管理员 | admin | admin123 |
| 修复专家 | restorer1 | 123456 |
| 评估专家 | evaluator1 | 123456 |

### 12.3 跨域配置
开发环境已配置CORS允许所有来源，生产环境需要配置具体域名。

## 13. API调用示例

### 13.1 完整的登录流程
```javascript
// 1. 用户登录
async function login(username, password) {
    const response = await fetch('http://localhost:8080/api/login', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ username, password })
    });
    
    if (response.ok) {
        const data = await response.json();
        // 保存token
        localStorage.setItem('access_token', data.access_token);
        // 保存用户信息
        localStorage.setItem('user', JSON.stringify(data.user));
        return data;
    } else {
        throw new Error('登录失败');
    }
}

// 2. 带认证的API请求
async function getWorkflows() {
    const token = localStorage.getItem('access_token');
    const response = await fetch('http://localhost:8080/api/workflows', {
        headers: {
            'Authorization': `Bearer ${token}`
        }
    });
    
    if (response.status === 401) {
        // Token过期，跳转登录
        window.location.href = '/login';
        return;
    }
    
    return response.json();
}
```

### 13.2 文件上传示例
```javascript
async function uploadFile(file) {
    const token = localStorage.getItem('access_token');
    const formData = new FormData();
    formData.append('file', file);
    
    const response = await fetch('http://localhost:8080/api/upload', {
        method: 'POST',
        headers: {
            'Authorization': `Bearer ${token}`
        },
        body: formData
    });
    
    if (response.ok) {
        return response.json();
    } else {
        throw new Error('文件上传失败');
    }
}
```

### 13.3 创建工作流并提交表单
```javascript
// 1. 创建工作流
async function createWorkflow(title, description) {
    const response = await fetch('http://localhost:8080/api/workflows', {
        method: 'POST',
        headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ title, description })
    });
    return response.json();
}

// 2. 提交修复表单
async function submitForm(workflowId, formData) {
    const data = new FormData();
    data.append('workflow_id', workflowId);
    data.append('image_desc', formData.imageDesc);
    data.append('restoration_opinion', formData.opinion);
    data.append('opinion_tags', JSON.stringify(formData.tags));
    if (formData.imageFile) {
        data.append('image_file', formData.imageFile);
    }
    
    const response = await fetch('http://localhost:8080/api/forms', {
        method: 'POST',
        headers: {
            'Authorization': `Bearer ${token}`
        },
        body: data
